CommentPress.texthighlighter={},CommentPress.texthighlighter.utilities=new function(){var t=this,e=jQuery.noConflict();this.localisation=new Array,"undefined"!=typeof CommentpressTextSelectorSettings&&(t.localisation=CommentpressTextSelectorSettings.localisation),this.localisation_set=function(e){t.localisation=e},this.localisation_get=function(e){return e in t.localisation?t.localisation[e]:""},this.saved_scroll_target="",this.saved_scroll_target_set=function(e){t.saved_scroll_target=e},this.saved_scroll_target_get=function(){return t.saved_scroll_target},this.init=function(){},this.dom_ready=function(){},this.selection_get=function(e){return t.selection_get_current(document.getElementById(e))},this.selection_clear=function(){window.getSelection?window.getSelection().empty?window.getSelection().empty():window.getSelection().removeAllRanges&&window.getSelection().removeAllRanges():document.selection&&document.selection.empty()},window.getSelection&&document.createRange?(this.selection_get_current=function(t){var e,n,o;return e=window.getSelection().getRangeAt(0),n=e.cloneRange(),n.selectNodeContents(t),n.setEnd(e.startContainer,e.startOffset),o=n.toString().length,{text:e.toString(),start:o,end:o+e.toString().length}},this.selection_restore=function(t,e){var n,o,i=0,c=document.createRange(),s=[t],r=!1,m=!1;for(c.setStart(t,0),c.collapse(!0);!m&&(n=s.pop());)if(3==n.nodeType){var l=i+n.length;!r&&e.start>=i&&e.start<=l&&(c.setStart(n,e.start-i),r=!0),r&&e.end>=i&&e.end<=l&&(c.setEnd(n,e.end-i),m=!0),i=l}else for(var h=n.childNodes.length;h--;)s.push(n.childNodes[h]);o=window.getSelection(),o.removeAllRanges(),o.addRange(c)}):document.selection&&document.body.createTextRange&&(this.selection_get_current=function(t){var e,n,o;return e=document.selection.createRange(),n=document.body.createTextRange(),n.moveToElementText(t),n.setEndPoint("EndToStart",e),o=n.text.length,{text:e.text,start:o,end:o+e.text.length}},this.selection_restore=function(t,e){var n;n=document.body.createTextRange(),n.moveToElementText(t),n.collapse(!0),n.moveEnd("character",e.end),n.moveStart("character",e.start),n.select()}),this.highlights_clear_all=function(){e(".inline-highlight").each(function(){var t=e(this).contents();e(this).replaceWith(t)})}},CommentPress.texthighlighter.textblocks=new function(){var t=this,e=jQuery.noConflict();"undefined"!=typeof CommentpressTextSelectorSettings&&(t.popover_textblock=CommentpressTextSelectorSettings.popover_textblock),this.init=function(){},this.dom_ready=function(){},this.container="",this.container_set=function(e){t.container=e},this.container_get=function(){return t.container},this.setup=function(){t.selection_build_for_comments(),t.setup_popover(),t.setup_content(),t.setup_comment_rollovers(),CommentPress.texthighlighter.commentform.setup(),t.highlighter_activate()},this.setup_popover=function(){e(t.popover_textblock).appendTo("body"),e(".popover-holder").mousedown(function(){return!1}),e(".popover-holder-btn-left-comment").click(function(){var n,o;return e(".popover-holder").hide(),CommentPress.texthighlighter.commentform.focus_activate(),t.selection_send_to_editor(!1),CommentPress.common.comments.scroll_comments(e("#respond"),cp_scroll_speed),n=t.container_get(),o=e("#"+n).wrapSelection({fitToWord:!1}).addClass("inline-highlight"),!1}),e(".popover-holder-btn-left-quote").click(function(){var n,o;return e(".popover-holder").hide(),CommentPress.texthighlighter.commentform.focus_activate(),t.selection_send_to_editor(!0),CommentPress.common.comments.scroll_comments(e("#respond"),cp_scroll_speed),n=t.container_get(),o=e("#"+n).wrapSelection({fitToWord:!1}).addClass("inline-highlight"),!1}),e(".popover-holder-btn-right").click(function(){e(".popover-holder").hide();var n="";return t.container_set(n),!1})},this.setup_content=function(){var n="",o="";"1"==cp_is_touch&&"1"==cp_touch_testing&&(n=" touchstart",o=" touchend"),e("#container").on("mousedown"+n,".textblock",function(){if("n"==CommentPress.texthighlighter.commentform.has_commentform())return void t.highlighter_disable();if(!CommentPress.texthighlighter.commentform.focus_is_active()){var n;n=e(this).prop("id"),t.container_set(n),t.highlighter_enable()}}),e("#container").on("mouseup"+o,".textblock",function(){if("n"!=CommentPress.texthighlighter.commentform.has_commentform()&&!CommentPress.texthighlighter.commentform.focus_is_active()){var n,o;n=t.container_get(),o=e(this).prop("id"),n!=o&&(t.container_set(""),t.highlighter_disable())}})},this.setup_comment_rollovers=function(){e("#comments_sidebar").on("mouseenter","li.comment.selection-exists",function(){var n,o;"block"!=e(".popover-holder").css("display")&&"block"!=e(".comment-popover-holder").css("display")&&(n=e(this).prop("id"),o=n.split("-")[2],t.selection_recall_for_comment(o))}),e("#comments_sidebar").on("mouseleave","li.comment.selection-exists",function(){"block"!=e(".popover-holder").css("display")&&"block"!=e(".comment-popover-holder").css("display")&&t.highlights_clear_for_comment()})},this.selection_send_to_editor=function(n){var o,i;e(document).unbind("click",t.highlighter_textblock_handler),i=t.container_get(),o=CommentPress.texthighlighter.utilities.selection_get(i),o=t.selection_normalise_for_commentform(i,o),CommentPress.texthighlighter.commentform.current_selection_set(o),n?"1"==cp_tinymce?e("#wp-comment-wrap").hasClass("html-active")?t.selection_add_to_textarea(o.text,"replace"):t.selection_add_to_tinymce(o.text,"replace"):t.selection_add_to_textarea(o.text,"replace"):"1"==cp_tinymce?e("#wp-comment-wrap").hasClass("html-active")?setTimeout(function(){e("#comment").focus()},200):setTimeout(function(){tinymce.activeEditor.focus()},200):setTimeout(function(){e("#comment").focus()},200)},this.selection_normalise_for_commentform=function(t,n){var o;return o=e("#"+t+" .comment_count").html().length,o>1?{text:n.text,start:n.start-(o-1),end:n.end-(o-1)}:n},this.selection_add_to_textarea=function(t,n){"prepend"==n?content=e("#comment").val():content="",setTimeout(function(){e("#comment").val("<strong>["+t+"]</strong>\n\n"+content),e("#comment").focus()},200)},this.selection_add_to_tinymce=function(t,e){"prepend"==e?content=tinymce.activeEditor.getContent():content="",tinymce.activeEditor.setContent("<p><strong>["+t+"]</strong></p><p></p>"+content,{format:"html"}),setTimeout(function(){tinymce.activeEditor.selection.select(tinymce.activeEditor.getBody(),!0),tinymce.activeEditor.selection.collapse(!1),tinymce.activeEditor.focus()},200)},this.highlighter_activate=function(){e(".textblock").highlighter({selector:".popover-holder",minWords:1,complete:function(){e(document).bind("click",t.highlighter_textblock_handler)}})},this.highlighter_deactivate=function(){e(".textblock").highlighter("destroy"),e(document).unbind("click",t.highlighter_textblock_handler)},this.highlighter_textblock_handler=function(n){e(n.target).closest(".popover-holder").length||(t.highlighter_deactivate(),t.highlighter_activate())},this.highlighter_enable=function(){e(".textblock").highlighter("enable")},this.highlighter_disable=function(){e(".textblock").highlighter("disable")},this.highlights_clear_content=function(){e(".textblock .inline-highlight").each(function(){var t=e(this).contents();e(this).replaceWith(t)})},this.highlights_clear_for_comment=function(){e(".textblock .inline-highlight-per-comment").each(function(){var t=e(this).contents();e(this).replaceWith(t)})},this.selections_by_comment={},this.selection_build_for_comments=function(){e("#comments_sidebar li.selection-exists").each(function(){var n,o,i,c,s,r,m;n=e(this).prop("id"),o=n.split("-")[2],i="#comment-"+o,c=e(this).attr("class").split(/\s+/),e.each(c,function(e,n){n.match("sel_start-")&&(s=parseInt(n.split("sel_start-")[1])),n.match("sel_end-")&&(r=parseInt(n.split("sel_end-")[1])),m={start:s,end:r},t.selections_by_comment[i]=m})})},this.selection_save_for_comment=function(e){var n,o;n="#comment-"+e,o=CommentPress.texthighlighter.commentform.current_selection_get(),t.selections_by_comment[n]=o,CommentPress.texthighlighter.commentform.current_selection_clear()},this.selection_recall_for_comment=function(n){var o,i,c,s;s="#comment-"+n,s in t.selections_by_comment&&(o=t.selections_by_comment[s],i=e.get_text_sig_by_comment_id(s),c="textblock-"+i,o=t.selection_normalise_for_comment(c,o),CommentPress.texthighlighter.utilities.selection_restore(document.getElementById(c),o),e("#"+c).wrapSelection({fitToWord:!1}).addClass("inline-highlight-per-comment"))},this.selection_normalise_for_comment=function(t,n){var o;return o=e("#"+t+" .comment_count").html().length,o>1?{start:n.start+(o-1),end:n.end+(o-1)}:n},this.selections_by_textblock={},this.selection_save_for_textblock=function(e){var n=t.selection_get_current(document.getElementById(e));e in t.selections_by_textblock||(t.selections_by_textblock[e]=[]),t.selections_by_textblock[e].push(n)},this.selection_recall_for_textblock=function(n){if(n in t.selections_by_textblock)for(var o,i=0;o=t.selections_by_textblock[n][i++];)CommentPress.texthighlighter.utilities.selection_restore(document.getElementById(n),o),e("#"+n).wrapSelection({fitToWord:!1}).addClass("inline-highlight")}},CommentPress.texthighlighter.commentform=new function(){var t=this,e=jQuery.noConflict();this.commentform_exists="n",this.set_commentform_flag=function(e){t.commentform_exists=e},this.has_commentform=function(){return t.commentform_exists},this.init=function(){},this.dom_ready=function(){},this.setup=function(){var n,o;n=e("#commentform"),0!=n.length&&(t.set_commentform_flag("y"),o='<input type="hidden" name="text_selection" id="text_selection" value="" />',e(o).appendTo("#commentform"))},this.comment_content_exists=function(){return"1"==cp_tinymce?e("#wp-comment-wrap").hasClass("html-active")?content=e("#comment").val():"undefined"!=typeof tinymce.activeEditor?content=tinymce.activeEditor.getContent():content=e("#comment").val():content=e("#comment").val(),""!=content},this.comment_content_clear=function(){"1"==cp_tinymce?e("#wp-comment-wrap").hasClass("html-active")?e("#comment").val(""):"undefined"!=typeof tinymce.activeEditor?tinymce.activeEditor.setContent("",{format:"html"}):e("#comment").val(""):e("#comment").val("")},this.selection_in_editor={},this.current_selection_set=function(n){t.selection_in_editor=n,e("#text_selection").val(n.start+","+n.end)},this.current_selection_get=function(){return t.selection_in_editor},this.current_selection_exists=function(){return!e.isEmptyObject(t.selection_in_editor)},this.current_selection_clear=function(){t.selection_in_editor={},e("#text_selection").val("")},this.focus_active=!1,this.focus_activate=function(){t.focus_active=!0,e(document).bind("click",t.focus_active_handler)},this.focus_is_active=function(){return t.focus_active},this.focus_clear=function(){t.focus_active=!1,e(document).unbind("click",t.focus_active_handler)},this.focus_active_handler=function(n){e(n.target).closest("#respond").length||e(n.target).closest(".comment-content").length||(t.current_selection_exists()&&t.comment_content_exists()?(t.modal(),e(document).unbind("click",t.focus_active_handler)):t.modal_yes())},this.modal_markup={},this.modal=function(){var n,o,i,c,s;n=CommentPress.texthighlighter.utilities.localisation_get("dialog_title"),o=CommentPress.texthighlighter.utilities.localisation_get("dialog_content"),t.modal_markup=e('<div id="dialog" title="'+n+'"><p class="cp_alert_text">'+o+"</p></div>"),i=CommentPress.texthighlighter.utilities.localisation_get("dialog_yes"),c=CommentPress.texthighlighter.utilities.localisation_get("dialog_no"),s={resizable:!1,width:400,height:200,zIndex:3999,modal:!0,dialogClass:"wp-dialog",buttons:[{text:i,click:function(){t.modal_yes(),e(this).dialog("destroy"),e(this).remove()}},{text:c,click:function(){e(this).dialog("close"),e(this).dialog("destroy"),e(this).remove()}}],close:function(){setTimeout(function(){t.modal_cancel()},5)}},t.modal_markup.appendTo("body"),t.modal_markup.dialog(s)},this.modal_yes=function(){t.comment_content_clear(),t.current_selection_clear(),CommentPress.texthighlighter.textblocks.highlighter_deactivate(),CommentPress.texthighlighter.textblocks.highlighter_activate(),t.focus_clear(),CommentPress.texthighlighter.utilities.highlights_clear_all()},this.modal_cancel=function(){t.focus_activate(),CommentPress.texthighlighter.utilities.selection_clear(),CommentPress.texthighlighter.textblocks.highlighter_disable()}},CommentPress.texthighlighter.comments=new function(){var t=this,e=jQuery.noConflict();this.popover_comment="","undefined"!=typeof CommentpressTextSelectorSettings&&(t.popover_comment=CommentpressTextSelectorSettings.popover_comment),this.init=function(){},this.dom_ready=function(){},this.container="",this.container_set=function(e){t.container=e},this.container_get=function(){return t.container},this.setup=function(){t.setup_popover(),t.setup_content(),t.highlighter_activate()},this.setup_popover=function(){e(t.popover_comment).appendTo("body"),e(".comment-popover-holder").mousedown(function(){return!1}),e(".comment-popover-holder-btn-left-quote").click(function(){var n,o;return e(".comment-popover-holder").hide(),t.selection_send_to_editor(!0),CommentPress.common.comments.scroll_comments(e("#respond"),cp_scroll_speed),n=t.container_get(),o=e("#"+n).wrapSelection({fitToWord:!1}).addClass("inline-highlight"),!1}),e(".popover-holder-btn-right").click(function(){e(".comment-popover-holder").hide();var n="";return t.container_set(n),!1})},this.setup_content=function(){e("#comments_sidebar").on("mousedown",".comment-content",function(){if("n"==CommentPress.texthighlighter.commentform.has_commentform())return void t.highlighter_disable();var n;n=e(this).parent().prop("id"),t.container_set(n),t.highlighter_enable()}),e("#comments_sidebar").on("mouseup",".comment-content",function(){if("n"!=CommentPress.texthighlighter.commentform.has_commentform()){var n,o;n=t.container_get(),o=e(this).parent().prop("id"),n!=o&&(t.container_set(""),t.highlighter_disable())}}),e("#comments_sidebar").on("click",".comment-forwardlink",function(t){var n,o,i,c,s,r,m,l;t.preventDefault(),o=e(this).prop("href").split("#")[1],n=e(this).parents("li.comment").map(function(){return this}),n.length>0&&(i=e(n[0]),c=i.prop("id").split("-")[2],s=CommentPress.texthighlighter.utilities.localisation_get("backlink_text"),r='<a href="#comment-'+c+'" class="comment-backlink">'+s+"</a>",e("#"+o+" .comment-identifier .comment-backlink").length||e(r).prependTo("#"+o+" .comment-identifier"),m=e(this).closest(".paragraph_wrapper").prop("id"),l=e("#"+o).closest(".paragraph_wrapper").prop("id"),m!=l&&e("#"+l).show(),CommentPress.common.comments.scroll_comments(e("#"+o),300,"flash"))}),e("#comments_sidebar").on("click",".comment-backlink",function(t){var n,o,i;t.preventDefault(),n=e(this).prop("href").split("#")[1],o=e(this).closest(".paragraph_wrapper").prop("id"),i=e("#"+n).closest(".paragraph_wrapper").prop("id"),o!=i&&e("#"+i).show(),CommentPress.common.comments.scroll_comments(e("#"+n),300,"flash"),e(this).remove()})},this.selection_send_to_editor=function(n){var o;e(document).unbind("click",t.highlighter_comment_handler),o=CommentPress.texthighlighter.utilities.selection_get(t.container_get()),n?"1"==cp_tinymce?e("#wp-comment-wrap").hasClass("html-active")?t.selection_add_to_textarea(o.text):t.selection_add_to_tinymce(o.text):t.selection_add_to_textarea(o.text):"1"==cp_tinymce?e("#wp-comment-wrap").hasClass("html-active")?setTimeout(function(){e("#comment").focus()},200):setTimeout(function(){"undefined"!=typeof tinymce.activeEditor?tinymce.activeEditor.focus():e("#comment").focus()},200):setTimeout(function(){e("#comment").focus()},200)},this.get_link=function(e){var n,o;return n=t.container_get(),o='<a href="#'+n+'" class="comment-forwardlink">'+e+"</a>"},this.selection_add_to_textarea=function(n){e("#comment").val(e("#comment").val()+t.get_link(n)),setTimeout(function(){e("#comment").focus(),t.highlights_clear_comment()},200)},this.selection_add_to_tinymce=function(e){tinymce.activeEditor.execCommand("mceInsertContent",!1,t.get_link(e)),setTimeout(function(){tinymce.activeEditor.focus(),t.highlights_clear_comment()},200)},this.highlighter_activate=function(){e("#comments_sidebar .comment-content").highlighter({selector:".comment-popover-holder",minWords:1,complete:function(){e(document).bind("click",t.highlighter_comment_handler)}})},this.highlighter_deactivate=function(){e("#comments_sidebar .comment-content").highlighter("destroy"),e(document).unbind("click",t.highlighter_comment_handler)},this.highlighter_comment_handler=function(n){e(n.target).closest(".comment-popover-holder").length||(t.highlighter_deactivate(),t.highlighter_activate())},this.highlighter_enable=function(){e("#comments_sidebar .comment-content").highlighter("enable")},this.highlighter_disable=function(){e("#comments_sidebar .comment-content").highlighter("disable")},this.highlights_clear_comment=function(){e("#comments_sidebar .comment-content .inline-highlight").each(function(){var t=e(this).contents();e(this).replaceWith(t)})}},CommentPress.texthighlighter.utilities.init(),jQuery(document).ready(function(t){t(document).on("commentpress-document-ready",function(){CommentPress.texthighlighter.textblocks.setup(),CommentPress.texthighlighter.comments.setup()}),t(document).on("commentpress-ajax-comment-added-scrolled",function(){CommentPress.texthighlighter.utilities.highlights_clear_all()}),t(document).on("commentpress-ajax-comment-added",function(t,e){e.match("#comment-")&&(e=parseInt(e.split("#comment-")[1])),CommentPress.texthighlighter.textblocks.selection_save_for_comment(e),CommentPress.texthighlighter.commentform.current_selection_clear(),CommentPress.texthighlighter.commentform.focus_clear(),CommentPress.texthighlighter.comments.highlighter_deactivate(),CommentPress.texthighlighter.comments.highlighter_activate()}),t(document).on("commentpress-textblock-pre-align commentpress-comment-block-permalink-pre-align commentpress-commenticonbox-pre-align commentpress-link-in-textblock-pre-align",function(){CommentPress.texthighlighter.commentform.focus_is_active()&&CommentPress.texthighlighter.commentform.comment_content_exists()&&(CommentPress.texthighlighter.utilities.saved_scroll_target_set(CommentPress.settings.textblock.get_scroll_target()),CommentPress.settings.textblock.set_scroll_target("none"))}),t(document).on("commentpress-textblock-click commentpress-comment-block-permalink-clicked commentpress-commenticonbox-clicked commentpress-link-in-textblock-clicked",function(){CommentPress.texthighlighter.commentform.focus_is_active()&&CommentPress.texthighlighter.commentform.comment_content_exists()&&(CommentPress.settings.textblock.set_scroll_target(CommentPress.texthighlighter.utilities.saved_scroll_target_get()),t(document).click())})});
