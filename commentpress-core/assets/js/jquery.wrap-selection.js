!function(e){e.fn.getRangeAt=function(){var n=this,t=e.fn.range;if(t.ClearVariables(),t.setRange(),this[0]===document);else{var r=e(t.startContainer).parents().index(n),o=e(t.endContainer).parents().index(n);if(-1===r||-1===o)return t.ClearVariables(),!1}return t},e.fn.wrapSelection=function(n){function t(n,t){t?e.fn.range=t:e(n).getRangeAt()}function r(){var n=e.fn.range,t=n.startContainer===n.endContainer;if(3===n.startContainer.nodeType&&n.startOffset>0){var r=n.startContainer.splitText(n.startOffset);t&&(n.endContainer=r,n.endOffset=n.endOffset-n.startContainer.length),n.startContainer=r,n.startOffset=0}3===n.endContainer.nodeType&&n.endOffset<n.endContainer.length&&(n.endContainer.splitText(n.endOffset),n.endOffset=n.endContainer.length)}function o(n,t){if(0>t){var r=e.fn.wrapSelection.dom.GetPreviousTextNode(n);r&&(n=r,t=n.length)}if(t<n.length-1)return{container:n,offset:t+1,character:n.nodeValue.substr(t+1,1)};var o=e.fn.wrapSelection.dom.GetNextTextNode(n,n.parentNode);if(!o)return{container:n,offset:t,character:""};for(var i=e.fn.wrapSelection.dom.GetNextSiblingElement(n);i&&2&e.fn.compareDocumentPosition(o,i);){if(i.nodeName.match(h.regexElementBlockers))return{container:n,offset:t,character:""};i=e.fn.wrapSelection.dom.GetNextSiblingElement(i)}return{container:o,offset:0,character:o.nodeValue.substr(0,1)}}function i(n,t){if(t>0)return{container:n,offset:t-1,character:n.nodeValue.substr(t-1,1)};var r=e.fn.wrapSelection.dom.GetPreviousTextNode(n);if(!r)return{container:n,offset:t,character:""};for(var o=e.fn.wrapSelection.dom.GetPreviousSiblingElement(n);o&&4&e.fn.compareDocumentPosition(r,o);){if(o.nodeName.match(h.regexElementBlockers))return{container:n,offset:t,character:""};o=e.fn.wrapSelection.dom.GetPreviousSiblingElement(o)}return{container:r,offset:r.length-1,character:r.nodeValue.substr(r.length-1,1)}}function a(e,n,t){var r="";if(n>0)r=e.nodeValue.substr(n-1,1);else{var s=i(e,n);h.regexWordCharacterFull.test(s.character)&&(r=e.nodeValue.substr(n,0,1),n=1)}if(h.regexWordCharacterBasic.test(r)){if("normal"===t){var c=o(e,n-1);if(h.regexWordCharacterFull.test(c.character))return a(c.container,c.offset+1,"normal")}return{container:e,offset:n}}if("normal"===t&&h.regexWordPunc.test(r)){var c=o(e,n);return h.regexWordNumbers.test(c.character)?a(c.container,c.offset,"normal"):{container:e,offset:n-1}}var s=i(e,n-1);return 1===s.character.length?a(s.container,s.offset+1,"reverse"):{container:e,offset:n}}function s(e,n,t){var r=e.nodeValue.substr(n,1);if(h.regexWordCharacterBasic.test(r)){if("normal"===t){var a=i(e,n);if(h.regexWordCharacterFull.test(a.character))return s(a.container,a.offset,"normal")}return{container:e,offset:n}}if("normal"===t&&h.regexWordPunc.test(r)){var a=i(e,n);if(h.regexWordNumbers.test(a.character))return s(a.container,a.offset,"normal")}var c=o(e,n);return 1===c.character.length?s(c.container,c.offset,"reverse"):{container:e,offset:n}}function c(){var n=e.fn.range,t=s(n.startContainer,n.startOffset,"normal"),r=a(n.endContainer,n.endOffset,"normal");n.startContainer=t.container,n.startOffset=t.offset,n.endContainer=r.container,n.endOffset=r.offset}function f(){var n=e.fn.range;if(!n.startContainer||!n.endContainer)return!1;for(var t=n.GetContainedNodes(),r=t.length,o=0,i=0;r>i;i++)if(t[i][0])for(var a=0,s=t[i].length;s>a;a++)e(t[i][a]).find("*").add(e(t[i][a])).contents().add(e(t[i][a])).filter(function(){return 3!==this.nodeType?!1:e.trim(this.textContent).length>0}).wrap(l()),o+=1;return o}function l(){var e=document.createElement("span");return e.className=h.selectClass,e}var u=e.fn.range,d="sel_"+(new Date).getTime(),g={fitToWord:!0,wrapRange:!1,selectClass:d,regexElementBlockers:new RegExp(/^BR$/),regexWordCharacterBasic:new RegExp(/^\S$/),regexWordCharacterFull:new RegExp(/^[A-Za-z0-9':,\-]$/),regexWordPunc:new RegExp(/^[:,]$/),regexWordNumbers:new RegExp(/^[0-9]$/)},h=e.extend({},g,n);if(t(this,h.wrapRange),u.startContainer&&u.endContainer){h.fitToWord&&c(),r();var m=f();return m?u.ClearAllRanges():u.ClearVariables(),e("."+h.selectClass)}return e([])},e.fn.range={onlySpacesMatch:new RegExp(/[^\t\r\n ]/),containedNodes:null,selection:null,commonAncestorContainer:null,startContainer:null,startOffset:null,endContainer:null,endOffset:null,collapsed:!0,setRange:function(){if(window.getSelection?this.selection=window.getSelection():document.selection&&(this.selection=document.selection.createRange()),this.selection.getRangeAt)var e=this.selection.getRangeAt(0);else{var e=document.createRange();e.setStart(this.selection.anchorNode,this.selection.anchorOffset),e.setEnd(this.selection.focusNode,this.selection.focusOffset)}return e.toString().match(this.onlySpacesMatch)?(this.startContainer=e.startContainer,this.startOffset=e.startOffset,this.endContainer=e.endContainer,this.endOffset=e.endOffset,void(this.collapsed=e.collapsed)):!1},ClearAllRanges:function(){e.fn.range.selection&&(e.fn.range.selection.removeAllRanges(),e.fn.range.ClearVariables())},ClearVariables:function(){this.selection=null,this.commonAncestorContainer=null,this.containedNodes=null,this.startContainer=null,this.startOffset=null,this.endContainer=null,this.endOffset=null,this.collapsed=!0},GetContainedNodes:function(){return this.doGetContainedNodes()},doGetContainedNodes:function(){if(this.containedNodes)return this.containedNodes;if(!this.startContainer||!this.endContainer)return[];for(var n=this.startContainer,t=this.endContainer,r=new Array([]),o=n,i=e.fn.compareDocumentPosition(n,t),a=o.parentNode,s=0;4&i||0===i;){if(16&i)o=o.firstChild;else if(a!==o.parentNode&&(s++,r[s]=[],a=o.parentNode),r[s].push(o),o=e.fn.wrapSelection.dom.GetNextSiblingOrParent(o),0===i)break;i=e.fn.compareDocumentPosition(o,t)}return this.containedNodes=r,r}},e.fn.wrapSelection.dom={GetNextSiblingElement:function(n){return e.fn.wrapSelection.dom.getElementOrder(n,"next")},GetNextSiblingOrParent:function(n){return e.fn.wrapSelection.dom.getSiblingOrParentOrder(n,"next")},GetNextTextNode:function(n,t){for(;n=e.fn.wrapSelection.dom.getNodeOrder(n,t,"next");)if(3===n.nodeType)return n;return n},GetPreviousSiblingElement:function(e){return this.getElementOrder(e,"previous")},GetPreviousTextNode:function(n,t){for(;n=e.fn.wrapSelection.dom.getNodeOrder(n,t,"previous");)if(3===n.nodeType)return n;return n},getElementOrder:function(e,n){for(n+="Sibling";e[n]&&1!==e[n].nodeType;)e=e[n];return e[n]},getSiblingOrParentOrder:function(e,n){var t=n+"Sibling";return e[t]?e[t]:e.parentNode?this.getSiblingOrParentOrder(e.parentNode,n):null},getNodeOrder:function(e,n,t){if("undefined"==typeof n&&(n=document.body),e.hasChildNodes())return"next"===t?e.firstChild:e.lastChild;if(e===n)return null;var r="next"===t?"nextSibling":"previousSibling";if(e[r])return e[r];for(;e=e.parentNode;){if(e===n)return null;if(e[r])return e[r]}return null}},msie_detected&&(e.extend(e.fn.range,{ClearAllRanges:function(){this.selection&&this.selection.empty(),this.ClearVariables()},setRange:function(){this.selection=document.selection;var n=this.selection.createRange(),t=n.text;if(!t.length)return!1;if(!t.match(this.onlySpacesMatch))return!1;var r=this.getInitialContainer(n.duplicate(),"start"),o=e.fn.wrapSelection.dom.SourceIndex(r.container,"string"),i=this.getInitialContainer(n.duplicate(),"end");return o===e.fn.wrapSelection.dom.SourceIndex(i.container,"string")&&(r.container=i.container),this.startContainer=r.container,this.startOffset=r.offset,this.endContainer=i.container,this.endOffset=i.offset,this.collapsed=r.container===i.container&&r.offset===i.offset,n.select(),!0},getInitialContainer:function(n,t){n.collapse("start"===t?!0:!1);var r=n.parentElement();n.pasteHTML('<span id="range-temp"></span>');var o=e("#range-temp")[0],i=0,a=e.fn.wrapSelection.dom.GetNextTextNode(o,o.parentNode);if(a||(a=e.fn.wrapSelection.dom.GetPreviousTextNode(o,o.parentNode),i=a.length),o.parentNode.removeChild(o),"start"===t){if(a.previousSibling&&3===a.previousSibling.nodeType){var s=r.removeChild(a.previousSibling);i+=s.length,a.insertData(0,s.nodeValue)}}else if(a.previousSibling&&3===a.previousSibling.nodeType){var s=a.previousSibling;i+=s.length,r.removeChild(a),s.appendData(a.nodeValue),a=s}return{container:a,offset:i}}}),e.extend(e.fn.wrapSelection.dom,{SourceIndex:function(e,n){var t=[];do{for(var r=0;e.previousSibling;)e=e.previousSibling,r++;t.unshift(r)}while(e=e.parentNode);return n&&"string"===n?t.join("."):t}})),e.fn.compareDocumentPosition=function(n,t){function r(e){var n;do n=e;while(e=e.parentNode);return n}function o(e,n){if(e.length===n.length)return n>e?4:2;if(e.length<n.length){var t=n.substr(0,e.length);return e===t?20:o(e,t)}var r=o(n,e);return 4&r?r>>1:r<<1}function i(e){var n=[];do{for(var t=0,r=e;r=r.previousSibling;)t++;var o=e.parentNode.childNodes.length.toString().length,i=t.toString().length;if(o>i)for(;o>=i;i++)t="0"+t;n.unshift(t)}while((e=e.parentNode)&&e!==document);return n.join(".")}return"compareDocumentPosition"in document.documentElement?e.fn.compareDocumentPosition=function(e,n){return e.compareDocumentPosition(n)}:"sourceIndex"in document.documentElement&&"contains"in document.documentElement?e.fn.compareDocumentPosition=function(e,n){function t(e,n){return(e.contains(n)&&16)+(n.contains(e)&&8)+(e.sourceIndex>=0&&n.sourceIndex>=0?(e.sourceIndex<n.sourceIndex&&4)+(e.sourceIndex>n.sourceIndex&&2):1)}function o(e){return"sourceIndex"in e?e:e.parentNode.insertBefore(document.createComment(""),e)}if(e===n)return 0;if(r(e)!==r(n))return 1;if("sourceIndex"in e&&"sourceIndex"in n)return t(e,n);if(e===document)return 20;if(n===document)return 10;var i=o(e),a=o(n),s=t(i,a);return e!==i&&i.parentNode.removeChild(i),n!==a&&a.parentNode.removeChild(a),s}:e.fn.compareDocumentPosition=function(e,n){return e===n?0:r(e)!==r(n)?1:e===document||"contains"in e&&"contains"in n&&e.contains(n)?20:n===document||"contains"in e&&"contains"in n&&n.contains(e)?10:o(i(e),i(n))},e.fn.compareDocumentPosition(n,t)}}(jQuery);