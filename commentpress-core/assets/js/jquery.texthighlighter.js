CommentPress.textselector=new function(){var t=this,e=jQuery.noConflict();this.init=function(){},this.dom_ready=function(){t.listeners()},this.saved_scroll_target="",this.listeners=function(){e(document).on("commentpress-document-ready",function(e){t.setup()}),e(document).on("commentpress-ajax-comment-added",function(t,e){e.match("#comment-")&&(e=parseInt(e.split("#comment-")[1])),CommentPress.textselector.textblocks.selection_save_for_comment(e),CommentPress.textselector.commentform.current_selection_clear(),CommentPress.textselector.commentform.focus_clear()}),e(document).on("commentpress-ajax-comment-added-scrolled",function(e){t.highlights_clear_all()}),e(document).on("commentpress-textblock-pre-align commentpress-commenticonbox-pre-align commentpress-link-in-textblock-pre-align",function(e){CommentPress.textselector.commentform.focus_is_active()&&CommentPress.textselector.commentform.comment_content_exists()&&(t.saved_scroll_target=CommentPress.settings.textblock.get_scroll_target(),CommentPress.settings.textblock.set_scroll_target("none"))}),e(document).on("commentpress-textblock-click commentpress-commenticonbox-clicked commentpress-link-in-textblock-clicked",function(n){CommentPress.textselector.commentform.focus_is_active()&&CommentPress.textselector.commentform.comment_content_exists()&&(CommentPress.settings.textblock.set_scroll_target(t.saved_scroll_target),e(document).click())})},this.setup=function(){CommentPress.textselector.textblocks.setup(),CommentPress.textselector.comments.setup()},this.selection_get=function(e){return t.selection_get_current(document.getElementById(e))},this.selection_clear=function(){window.getSelection?window.getSelection().empty?window.getSelection().empty():window.getSelection().removeAllRanges&&window.getSelection().removeAllRanges():document.selection&&document.selection.empty()},window.getSelection&&document.createRange?(this.selection_get_current=function(t){var e,n,o;return e=window.getSelection().getRangeAt(0),n=e.cloneRange(),n.selectNodeContents(t),n.setEnd(e.startContainer,e.startOffset),o=n.toString().length,{text:e.toString(),start:o,end:o+e.toString().length}},this.selection_restore=function(t,e){var n,o,c=0,i=document.createRange(),s=[t],r=!1,m=!1;for(i.setStart(t,0),i.collapse(!0);!m&&(n=s.pop());)if(3==n.nodeType){var l=c+n.length;!r&&e.start>=c&&e.start<=l&&(i.setStart(n,e.start-c),r=!0),r&&e.end>=c&&e.end<=l&&(i.setEnd(n,e.end-c),m=!0),c=l}else for(var a=n.childNodes.length;a--;)s.push(n.childNodes[a]);o=window.getSelection(),o.removeAllRanges(),o.addRange(i)}):document.selection&&document.body.createTextRange&&(this.selection_get_current=function(t){var e,n,o;return e=document.selection.createRange(),n=document.body.createTextRange(),n.moveToElementText(t),n.setEndPoint("EndToStart",e),o=n.text.length,{text:e.text,start:o,end:o+e.text.length}},this.selection_restore=function(t,e){var n;n=document.body.createTextRange(),n.moveToElementText(t),n.collapse(!0),n.moveEnd("character",e.end),n.moveStart("character",e.start),n.select()}),this.highlights_clear_all=function(){e(".inline-highlight").each(function(t){var n=e(this).contents();e(this).replaceWith(n)})}},CommentPress.textselector.textblocks=new function(){var t=this,e=jQuery.noConflict();"undefined"!=typeof CommentpressTextSelectorSettings&&(this.popover_textblock=CommentpressTextSelectorSettings.popover_textblock),this.init=function(){},this.dom_ready=function(){},this.container="",this.container_set=function(t){this.container=t},this.container_get=function(){return this.container},this.setup=function(){t.selection_build_for_comments(),t.setup_popover(),t.setup_content(),t.setup_comment_rollovers(),CommentPress.textselector.commentform.setup(),t.highlighter_activate()},this.setup_popover=function(){e(t.popover_textblock).appendTo("body"),e(".popover-holder").mousedown(function(){return!1}),e(".popover-holder-btn-left-comment").click(function(){var n,o;return e(".popover-holder").hide(),CommentPress.textselector.commentform.focus_activate(),t.selection_send_to_editor(!1),CommentPress.common.comments.scroll_comments(e("#respond"),cp_scroll_speed),n=t.container_get(),o=e("#"+n).wrapSelection({fitToWord:!1}).addClass("inline-highlight"),!1}),e(".popover-holder-btn-left-quote").click(function(){var n,o;return e(".popover-holder").hide(),CommentPress.textselector.commentform.focus_activate(),t.selection_send_to_editor(!0),CommentPress.common.comments.scroll_comments(e("#respond"),cp_scroll_speed),n=t.container_get(),o=e("#"+n).wrapSelection({fitToWord:!1}).addClass("inline-highlight"),!1}),e(".popover-holder-btn-right").click(function(){e(".popover-holder").hide();var n="";return t.container_set(n),!1})},this.setup_content=function(){e("#container").on("mousedown",".textblock",function(){if(!CommentPress.textselector.commentform.focus_is_active()){var n;n=e(this).prop("id"),t.container_set(n),t.highlighter_enable()}}),e("#container").on("mouseup",".textblock",function(){if(!CommentPress.textselector.commentform.focus_is_active()){var n,o;n=t.container_get(),o=e(this).prop("id"),n!=o&&(t.container_set(""),t.highlighter_disable())}})},this.setup_comment_rollovers=function(){e("#comments_sidebar").on("mouseenter","li.comment.selection-exists",function(n){var o,c;"block"!=e(".popover-holder").css("display")&&(o=e(this).prop("id"),c=o.split("-")[2],t.selection_recall_for_comment(c))}),e("#comments_sidebar").on("mouseleave","li.comment.selection-exists",function(n){"block"!=e(".popover-holder").css("display")&&t.highlights_clear_for_comment()})},this.selection_send_to_editor=function(n){var o;e(document).unbind("click",t.highlighter_textblock_handler),o=CommentPress.textselector.selection_get(t.container_get()),CommentPress.textselector.commentform.current_selection_set(o),n?"1"==cp_tinymce?e("#wp-comment-wrap").hasClass("html-active")?t.selection_add_to_textarea(o.text,"replace"):t.selection_add_to_tinymce(o.text,"replace"):t.selection_add_to_textarea(o.text,"replace"):"1"==cp_tinymce?e("#wp-comment-wrap").hasClass("html-active")?setTimeout(function(){e("#comment").focus()},200):setTimeout(function(){tinymce.activeEditor.focus()},200):setTimeout(function(){e("#comment").focus()},200)},this.selection_add_to_textarea=function(t,n){"prepend"==n?content=e("#comment").val():content="",setTimeout(function(){e("#comment").val("<strong>["+t+"]</strong>\n\n"+content),e("#comment").focus()},200)},this.selection_add_to_tinymce=function(t,e){"prepend"==e?content=tinymce.activeEditor.getContent():content="",tinymce.activeEditor.setContent("<p><strong>["+t+"]</strong></p>"+content,{format:"html"}),setTimeout(function(){tinymce.activeEditor.selection.select(tinymce.activeEditor.getBody(),!0),tinymce.activeEditor.selection.collapse(!1),tinymce.activeEditor.focus()},200)},this.highlighter_activate=function(){e(".textblock").highlighter({selector:".popover-holder",minWords:1,complete:function(n){e(document).bind("click",t.highlighter_textblock_handler)}})},this.highlighter_deactivate=function(){e(".textblock").highlighter("destroy"),e(document).unbind("click",t.highlighter_textblock_handler)},this.highlighter_textblock_handler=function(n){e(n.target).closest(".popover-holder").length||(t.highlighter_deactivate(),t.highlighter_activate())},this.highlighter_enable=function(){e(".textblock").highlighter("enable")},this.highlighter_disable=function(){e(".textblock").highlighter("disable")},this.highlights_clear_content=function(){e(".textblock .inline-highlight").each(function(t){var n=e(this).contents();e(this).replaceWith(n)})},this.highlights_clear_for_comment=function(){e(".textblock .inline-highlight-per-comment").each(function(t){var n=e(this).contents();e(this).replaceWith(n)})},this.selections_by_comment={},this.selection_build_for_comments=function(){e("#comments_sidebar li.selection-exists").each(function(n){var o,c,i,s,r,m,l;o=e(this).prop("id"),c=o.split("-")[2],i="#comment-"+c,s=e(this).attr("class").split(/\s+/),e.each(s,function(e,n){n.match("sel_start-")&&(r=parseInt(n.split("sel_start-")[1])),n.match("sel_end-")&&(m=parseInt(n.split("sel_end-")[1])),l={start:r,end:m},t.selections_by_comment[i]=l})})},this.selection_save_for_comment=function(t){var e,n;e="#comment-"+t,n=CommentPress.textselector.commentform.current_selection_get(),this.selections_by_comment[e]=n,CommentPress.textselector.commentform.current_selection_clear()},this.selection_recall_for_comment=function(t){var n,o,c,i;i="#comment-"+t,i in this.selections_by_comment&&(n=this.selections_by_comment[i],o=e.get_text_sig_by_comment_id(i),c="textblock-"+o,CommentPress.textselector.selection_restore(document.getElementById(c),n),e("#"+c).wrapSelection({fitToWord:!1}).addClass("inline-highlight-per-comment"))},this.selections_by_textblock={},this.selection_save_for_textblock=function(e){var n=t.selection_get_current(document.getElementById(e));e in this.selections_by_textblock||(this.selections_by_textblock[e]=[]),this.selections_by_textblock[e].push(n)},this.selection_recall_for_textblock=function(t){if(t in this.selections_by_textblock)for(var n,o=0;n=this.selections_by_textblock[t][o++];)CommentPress.textselector.selection_restore(document.getElementById(t),n),e("#"+t).wrapSelection({fitToWord:!1}).addClass("inline-highlight")}},CommentPress.textselector.commentform=new function(){var t=this,e=jQuery.noConflict();this.init=function(){},this.dom_ready=function(){},this.setup=function(){var t;t='<input type="hidden" name="text_selection" id="text_selection" value="" />',e(t).appendTo("#commentform")},this.comment_content_exists=function(){return"1"==cp_tinymce?e("#wp-comment-wrap").hasClass("html-active")?content=e("#comment").val():"undefined"!=typeof tinymce.activeEditor?content=tinymce.activeEditor.getContent():content=e("#comment").val():content=e("#comment").val(),""==content?!1:!0},this.comment_content_clear=function(){"1"==cp_tinymce?e("#wp-comment-wrap").hasClass("html-active")?e("#comment").val(""):"undefined"!=typeof tinymce.activeEditor?tinymce.activeEditor.setContent("",{format:"html"}):e("#comment").val(""):e("#comment").val("")},this.selection_in_editor={},this.current_selection_set=function(t){this.selection_in_editor=t,e("#text_selection").val(t.start+","+t.end)},this.current_selection_get=function(){return this.selection_in_editor},this.current_selection_exists=function(){return e.isEmptyObject(this.selection_in_editor)?!1:!0},this.current_selection_clear=function(){this.selection_in_editor={},e("#text_selection").val("")},this.focus_active=!1,this.focus_activate=function(){t.focus_active=!0,e(document).bind("click",t.focus_active_handler)},this.focus_is_active=function(){return this.focus_active},this.focus_clear=function(){this.focus_active=!1,e(document).unbind("click",t.focus_active_handler)},this.focus_active_handler=function(n){e(n.target).closest("#commentform").length||(console.log("the event target is not the comment form"),e(n.target).closest(".comment-content").length||(console.log("the event target is not a comment"),t.current_selection_exists()?(console.log("we have a selection"),t.comment_content_exists()?(console.log("we have comment content"),t.modal(),e(document).unbind("click",t.focus_active_handler)):(console.log("we DO NOT have comment content"),t.modal_yes())):(console.log("we DO NOT have a selection"),t.modal_yes())))},this.modal_markup={},this.modal=function(n){var o,c,i,s,r;o="Are you sure?",c="You have not yet submitted your comment. Are you sure you want to discard it?",t.modal_markup=e('<div id="dialog" title="'+o+'"><p class="cp_alert_text">'+c+"</p></div>"),i="Discard",s="Keep",r={resizable:!1,width:400,height:200,zIndex:3999,modal:!0,dialogClass:"wp-dialog",buttons:[{text:i,click:function(){t.modal_yes(),e(this).dialog("destroy"),e(this).remove()}},{text:s,click:function(){e(this).dialog("close"),e(this).dialog("destroy"),e(this).remove()}}],close:function(e,n){setTimeout(function(){t.modal_cancel()},5)}},t.modal_markup.appendTo("body"),t.modal_markup.dialog(r)},this.modal_yes=function(e){t.comment_content_clear(),t.current_selection_clear(),CommentPress.textselector.textblocks.highlighter_deactivate(),CommentPress.textselector.textblocks.highlighter_activate(),t.focus_clear(),CommentPress.textselector.highlights_clear_all()},this.modal_cancel=function(e){t.focus_activate(),CommentPress.textselector.selection_clear(),CommentPress.textselector.textblocks.highlighter_disable()}},CommentPress.textselector.comments=new function(){var t=this,e=jQuery.noConflict();"undefined"!=typeof CommentpressTextSelectorSettings&&(this.popover_comment=CommentpressTextSelectorSettings.popover_comment),this.init=function(){},this.dom_ready=function(){},this.container="",this.container_set=function(t){this.container=t},this.container_get=function(){return this.container},this.setup=function(){t.setup_popover(),t.setup_content(),t.highlighter_activate()},this.setup_popover=function(){e(t.popover_comment).appendTo("body"),e(".comment-popover-holder").mousedown(function(){return!1}),e(".comment-popover-holder-btn-left-quote").click(function(){var n,o;return e(".comment-popover-holder").hide(),t.selection_send_to_editor(!0),CommentPress.common.comments.scroll_comments(e("#respond"),cp_scroll_speed),n=t.container_get(),o=e("#"+n).wrapSelection({fitToWord:!1}).addClass("inline-highlight"),!1}),e(".popover-holder-btn-right").click(function(){e(".comment-popover-holder").hide();var n="";return t.container_set(n),!1})},this.setup_content=function(){e("#comments_sidebar").on("mousedown",".comment-content",function(){var n;n=e(this).parent().prop("id"),t.container_set(n),t.highlighter_enable()}),e("#comments_sidebar").on("mouseup",".comment-content",function(){var n,o;n=t.container_get(),o=e(this).parent().prop("id"),n!=o&&(t.container_set(""),t.highlighter_disable())}),e("#comments_sidebar").on("click",".comment-forwardlink",function(){var t,n,o,c;t=e(this).prop("href").split("#")[1],parent_comments_array=e(this).parents("li.comment").map(function(){return this}),parent_comments_array.length>0&&(n=e(parent_comments_array[0]),console.log(n),o=n.prop("id").split("-")[2],c='<a href="#comment-'+o+'" class="comment-backlink">BACK</a>',e(c).prependTo("#"+t+" .comment-identifier"),CommentPress.common.comments.scroll_comments(e("#"+t),300,"flash"))}),e("#comments_sidebar").on("click",".comment-backlink",function(){var t;t=e(this).prop("href").split("#")[1],CommentPress.common.comments.scroll_comments(e("#"+t),300,"flash"),e(this).remove()})},this.selection_send_to_editor=function(n){var o;e(document).unbind("click",t.highlighter_comment_handler),o=CommentPress.textselector.selection_get(t.container_get()),n?"1"==cp_tinymce?e("#wp-comment-wrap").hasClass("html-active")?t.selection_add_to_textarea(o.text):t.selection_add_to_tinymce(o.text):t.selection_add_to_textarea(o.text):"1"==cp_tinymce?e("#wp-comment-wrap").hasClass("html-active")?setTimeout(function(){e("#comment").focus()},200):setTimeout(function(){"undefined"!=typeof tinymce.activeEditor?tinymce.activeEditor.focus():e("#comment").focus()},200):setTimeout(function(){e("#comment").focus()},200)},this.get_link=function(e){var n,o;return n=t.container_get(),o='<a href="#'+n+'" class="comment-forwardlink">'+e+"</a>"},this.selection_add_to_textarea=function(n){e("#comment").val(e("#comment").val()+t.get_link(n)),setTimeout(function(){e("#comment").focus(),t.highlights_clear_comment()},200)},this.selection_add_to_tinymce=function(e){tinymce.activeEditor.execCommand("mceInsertContent",!1,t.get_link(e)),setTimeout(function(){tinymce.activeEditor.focus(),t.highlights_clear_comment()},200)},this.highlighter_activate=function(){e(".comment-content").highlighter({selector:".comment-popover-holder",minWords:1,complete:function(n){e(document).bind("click",t.highlighter_comment_handler)}})},this.highlighter_deactivate=function(){e(".comment-content").highlighter("destroy"),e(document).unbind("click",t.highlighter_comment_handler)},this.highlighter_comment_handler=function(n){e(n.target).closest(".comment-popover-holder").length||(t.highlighter_deactivate(),t.highlighter_activate())},this.highlighter_enable=function(){e(".comment-content").highlighter("enable")},this.highlighter_disable=function(){e(".comment-content").highlighter("disable")},this.highlights_clear_comment=function(){e(".comment-content .inline-highlight").each(function(t){var n=e(this).contents();e(this).replaceWith(n)})}},CommentPress.textselector.init(),jQuery(document).ready(function(t){CommentPress.textselector.dom_ready()});