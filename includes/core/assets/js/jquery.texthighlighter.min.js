CommentPress.texthighlighter={},CommentPress.texthighlighter.utilities=new function(){var t=this,e=jQuery.noConflict();this.localisation=[],"undefined"!=typeof CommentpressTextSelectorSettings&&(t.localisation=CommentpressTextSelectorSettings.localisation),this.localisation_set=function(e){t.localisation=e},this.localisation_get=function(e){return e in t.localisation?t.localisation[e]:""},this.saved_scroll_target="",this.saved_scroll_target_set=function(e){t.saved_scroll_target=e},this.saved_scroll_target_get=function(e){return t.saved_scroll_target},this.init=function(){},this.dom_ready=function(){},this.selection_get=function(e){return t.selection_get_current(document.getElementById(e))},this.selection_clear=function(){window.getSelection?window.getSelection().empty?window.getSelection().empty():window.getSelection().removeAllRanges&&window.getSelection().removeAllRanges():document.selection&&document.selection.empty()},window.getSelection&&document.createRange?(this.selection_get_current=function(t){var e,i,o;return(i=(e=window.getSelection().getRangeAt(0)).cloneRange()).selectNodeContents(t),i.setEnd(e.startContainer,e.startOffset),o=i.toString().length,{text:e.toString(),start:o,end:o+e.toString().length}},this.selection_restore=function(t,e){var i,o,n=0,c=document.createRange(),s=[t],l=!1,r=!1;for(c.setStart(t,0),c.collapse(!0);!r&&(i=s.pop());)if(3==i.nodeType){var h=n+i.length;!l&&e.start>=n&&e.start<=h&&(c.setStart(i,e.start-n),l=!0),l&&e.end>=n&&e.end<=h&&(c.setEnd(i,e.end-n),r=!0),n=h}else for(var a=i.childNodes.length;a--;)s.push(i.childNodes[a]);(o=window.getSelection()).removeAllRanges(),o.addRange(c)}):document.selection&&document.body.createTextRange&&(this.selection_get_current=function(t){var e,i,o;return e=document.selection.createRange(),(i=document.body.createTextRange()).moveToElementText(t),i.setEndPoint("EndToStart",e),o=i.text.length,{text:e.text,start:o,end:o+e.text.length}},this.selection_restore=function(t,e){var i;(i=document.body.createTextRange()).moveToElementText(t),i.collapse(!0),i.moveEnd("character",e.end),i.moveStart("character",e.start),i.select()}),this.highlights_clear_all=function(){e(".inline-highlight").each(function(t){var i=e(this).contents();e(this).replaceWith(i)})}},CommentPress.texthighlighter.textblocks=new function(){var t=this,e=jQuery.noConflict();"undefined"!=typeof CommentpressTextSelectorSettings&&(t.popover_textblock=CommentpressTextSelectorSettings.popover_textblock),this.init=function(){},this.dom_ready=function(){},this.container="",this.container_set=function(e){t.container=e},this.container_get=function(){return t.container},this.setup=function(){t.selection_build_for_comments(),t.setup_popover(),t.setup_content(),t.setup_comment_rollovers(),CommentPress.texthighlighter.commentform.setup(),t.highlighter_activate()},this.setup_popover=function(){e(t.popover_textblock).appendTo("body"),e(".popover-holder").on("mousedown",function(){return!1}),e(".popover-holder-btn-left-comment").on("click",function(){var i,o;return e(".popover-holder").hide(),CommentPress.texthighlighter.commentform.focus_activate(),t.selection_send_to_editor(!1),CommentPress.common.comments.scroll_comments(e("#respond"),cp_scroll_speed),o=e("#"+(i=t.container_get())).wrapSelection({fitToWord:!1}).addClass("inline-highlight"),!1}),e(".popover-holder-btn-left-quote").on("click",function(){var i,o;return e(".popover-holder").hide(),CommentPress.texthighlighter.commentform.focus_activate(),t.selection_send_to_editor(!0),CommentPress.common.comments.scroll_comments(e("#respond"),cp_scroll_speed),o=e("#"+(i=t.container_get())).wrapSelection({fitToWord:!1}).addClass("inline-highlight"),!1}),e(".popover-holder-btn-right").on("click",function(){return e(".popover-holder").hide(),t.container_set(""),!1})},this.setup_content=function(){var i="",o="";"1"==cp_is_touch&&"1"==cp_touch_testing&&(i=" touchstart",o=" touchend"),e("#container").on("mousedown"+i,".textblock",function(){var i;if("n"==CommentPress.texthighlighter.commentform.has_commentform()){t.highlighter_disable();return}!CommentPress.texthighlighter.commentform.focus_is_active()&&(i=e(this).prop("id"),t.container_set(i),t.highlighter_enable())}),e("#container").on("mouseup"+o,".textblock",function(){var i,o;!("n"==CommentPress.texthighlighter.commentform.has_commentform()||CommentPress.texthighlighter.commentform.focus_is_active())&&(i=t.container_get())!=(o=e(this).prop("id"))&&(t.container_set(""),t.highlighter_disable())})},this.setup_comment_rollovers=function(){e("#comments_sidebar").on("mouseenter","li.comment.selection-exists",function(i){var o,n;"block"!=e(".popover-holder").css("display")&&"block"!=e(".comment-popover-holder").css("display")&&(n=(o=e(this).prop("id")).split("-")[2],t.selection_recall_for_comment(n))}),e("#comments_sidebar").on("mouseleave","li.comment.selection-exists",function(i){"block"!=e(".popover-holder").css("display")&&"block"!=e(".comment-popover-holder").css("display")&&t.highlights_clear_for_comment()})},this.selection_send_to_editor=function(i){var o,n;e(document).off("click",t.highlighter_textblock_handler),n=t.container_get(),o=CommentPress.texthighlighter.utilities.selection_get(n),o=t.selection_normalise_for_commentform(n,o),CommentPress.texthighlighter.commentform.current_selection_set(o),i?"1"==cp_tinymce?e("#wp-comment-wrap").hasClass("html-active")?t.selection_add_to_textarea(o.text,"replace"):t.selection_add_to_tinymce(o.text,"replace"):t.selection_add_to_textarea(o.text,"replace"):"1"==cp_tinymce?e("#wp-comment-wrap").hasClass("html-active")?setTimeout(function(){e("#comment").focus()},200):setTimeout(function(){tinymce.activeEditor.focus()},200):setTimeout(function(){e("#comment").focus()},200)},this.selection_normalise_for_commentform=function(t,i){var o;return(o=e("#"+t+" .comment_count").html().length)>1?{text:i.text,start:i.start-(o-1),end:i.end-(o-1)}:i},this.selection_add_to_textarea=function(t,i){content="prepend"==i?e("#comment").val():"",setTimeout(function(){e("#comment").val("<strong>["+t+"]</strong>\n\n"+content),e("#comment").focus()},200)},this.selection_add_to_tinymce=function(t,e){content="prepend"==e?tinymce.activeEditor.getContent():"",tinymce.activeEditor.setContent("<p><strong>["+t+"]</strong></p><p></p>"+content,{format:"html"}),setTimeout(function(){tinymce.activeEditor.selection.select(tinymce.activeEditor.getBody(),!0),tinymce.activeEditor.selection.collapse(!1),tinymce.activeEditor.focus()},200)},this.highlighter_activate=function(){e(".textblock").highlighter({selector:".popover-holder",minWords:1,complete:function(i){e(document).on("click",t.highlighter_textblock_handler)}})},this.highlighter_deactivate=function(){e(".textblock").highlighter("destroy"),e(document).off("click",t.highlighter_textblock_handler)},this.highlighter_textblock_handler=function(i){e(i.target).closest(".popover-holder").length||(t.highlighter_deactivate(),t.highlighter_activate())},this.highlighter_enable=function(){e(".textblock").highlighter("enable")},this.highlighter_disable=function(){e(".textblock").highlighter("disable")},this.highlights_clear_content=function(){e(".textblock .inline-highlight").each(function(t){var i=e(this).contents();e(this).replaceWith(i)})},this.highlights_clear_for_comment=function(){e(".textblock .inline-highlight-per-comment").each(function(t){var i=e(this).contents();e(this).replaceWith(i)})},this.selections_by_comment={},this.selection_build_for_comments=function(){e("#comments_sidebar li.selection-exists").each(function(i){var o,n,c,s,l,r,h;c="#comment-"+(n=(o=e(this).prop("id")).split("-")[2]),s=e(this).attr("class").split(/\s+/),e.each(s,function(e,i){i.match("sel_start-")&&(l=parseInt(i.split("sel_start-")[1])),i.match("sel_end-")&&(r=parseInt(i.split("sel_end-")[1])),h={start:l,end:r},t.selections_by_comment[c]=h})})},this.selection_save_for_comment=function(e){var i,o;i="#comment-"+e,o=CommentPress.texthighlighter.commentform.current_selection_get(),t.selections_by_comment[i]=o,CommentPress.texthighlighter.commentform.current_selection_clear()},this.selection_recall_for_comment=function(i){var o,n,c,s;(s="#comment-"+i)in t.selections_by_comment&&(o=t.selections_by_comment[s],c="textblock-"+(n=e.get_text_sig_by_comment_id(s)),o=t.selection_normalise_for_comment(c,o),CommentPress.texthighlighter.utilities.selection_restore(document.getElementById(c),o),e("#"+c).wrapSelection({fitToWord:!1}).addClass("inline-highlight-per-comment"))},this.selection_normalise_for_comment=function(t,i){var o;return(o=e("#"+t+" .comment_count").html().length)>1?{start:i.start+(o-1),end:i.end+(o-1)}:i},this.selections_by_textblock={},this.selection_save_for_textblock=function(e){var i=t.selection_get_current(document.getElementById(e));e in t.selections_by_textblock||(t.selections_by_textblock[e]=[]),t.selections_by_textblock[e].push(i)},this.selection_recall_for_textblock=function(i){if(i in t.selections_by_textblock)for(var o,n=0;o=t.selections_by_textblock[i][n++];)CommentPress.texthighlighter.utilities.selection_restore(document.getElementById(i),o),e("#"+i).wrapSelection({fitToWord:!1}).addClass("inline-highlight")}},CommentPress.texthighlighter.commentform=new function(){var t=this,e=jQuery.noConflict();this.commentform_exists="n",this.set_commentform_flag=function(e){t.commentform_exists=e},this.has_commentform=function(){return t.commentform_exists},this.init=function(){},this.dom_ready=function(){},this.setup=function(){var i,o;0!=(i=e("#commentform")).length&&(t.set_commentform_flag("y"),e(o='<input type="hidden" name="text_selection" id="text_selection" value="" />').appendTo("#commentform"))},this.comment_content_exists=function(){return""!=(content="1"==cp_tinymce?e("#wp-comment-wrap").hasClass("html-active")?e("#comment").val():void 0===tinymce.activeEditor||null===tinymce.activeEditor?e("#comment").val():tinymce.activeEditor.getContent():e("#comment").val())},this.comment_content_clear=function(){"1"==cp_tinymce?e("#wp-comment-wrap").hasClass("html-active")?e("#comment").val(""):void 0===tinymce.activeEditor||null===tinymce.activeEditor?e("#comment").val(""):tinymce.activeEditor.setContent("",{format:"html"}):e("#comment").val("")},this.selection_in_editor={},this.current_selection_set=function(i){t.selection_in_editor=i,e("#text_selection").val(i.start+","+i.end)},this.current_selection_get=function(){return t.selection_in_editor},this.current_selection_exists=function(){return!e.isEmptyObject(t.selection_in_editor)},this.current_selection_clear=function(){t.selection_in_editor={},e("#text_selection").val("")},this.focus_active=!1,this.focus_activate=function(){t.focus_active=!0,e(document).on("click",t.focus_active_handler)},this.focus_is_active=function(){return t.focus_active},this.focus_clear=function(){t.focus_active=!1,e(document).off("click",t.focus_active_handler)},this.focus_active_handler=function(i){var o,n,c,s,l;if(o=e(i.target).closest(".mce-panel").length,wp_modal_link_options=e(i.target).closest("#wp-link").length,n=e(i.target).closest(".wplink-autocomplete").length,c=e(i.target).closest(".media-modal").length,!(o||wp_modal_link_options)&&!n&&!c)s=e(i.target).closest("#respond").length,l=e(i.target).closest(".comment-content").length,!s&&!l&&(t.current_selection_exists()&&t.comment_content_exists()?(t.modal(),e(document).off("click",t.focus_active_handler)):t.modal_yes())},this.modal_markup={},this.modal=function(i){var o,n,c,s,l;o=CommentPress.texthighlighter.utilities.localisation_get("dialog_title"),n=CommentPress.texthighlighter.utilities.localisation_get("dialog_content"),t.modal_markup=e('<div id="dialog" title="'+o+'"><p class="cp_alert_text">'+n+"</p></div>"),l={resizable:!1,width:400,height:200,zIndex:3999,modal:!0,dialogClass:"wp-dialog",buttons:[{text:c=CommentPress.texthighlighter.utilities.localisation_get("dialog_yes"),click:function(){t.modal_yes(),e(this).dialog("destroy"),e(this).remove()}},{text:s=CommentPress.texthighlighter.utilities.localisation_get("dialog_no"),click:function(){e(this).dialog("close"),e(this).dialog("destroy"),e(this).remove()}}],close:function(e,i){setTimeout(function(){t.modal_cancel()},5)}},t.modal_markup.appendTo("body"),t.modal_markup.dialog(l)},this.modal_yes=function(e){t.comment_content_clear(),t.current_selection_clear(),CommentPress.texthighlighter.textblocks.highlighter_deactivate(),CommentPress.texthighlighter.textblocks.highlighter_activate(),t.focus_clear(),CommentPress.texthighlighter.utilities.highlights_clear_all()},this.modal_cancel=function(e){t.focus_activate(),CommentPress.texthighlighter.utilities.selection_clear(),CommentPress.texthighlighter.textblocks.highlighter_disable()}},CommentPress.texthighlighter.comments=new function(){var t=this,e=jQuery.noConflict();this.popover_comment="","undefined"!=typeof CommentpressTextSelectorSettings&&(t.popover_comment=CommentpressTextSelectorSettings.popover_comment),this.init=function(){},this.dom_ready=function(){},this.container="",this.container_set=function(e){t.container=e},this.container_get=function(){return t.container},this.setup=function(){t.setup_popover(),t.setup_content(),t.highlighter_activate()},this.setup_popover=function(){e(t.popover_comment).appendTo("body"),e(".comment-popover-holder").on("mousedown",function(){return!1}),e(".comment-popover-holder-btn-left-quote").on("click",function(){var i,o;return e(".comment-popover-holder").hide(),t.selection_send_to_editor(!0),CommentPress.common.comments.scroll_comments(e("#respond"),cp_scroll_speed),o=e("#"+(i=t.container_get())).wrapSelection({fitToWord:!1}).addClass("inline-highlight"),!1}),e(".popover-holder-btn-right").on("click",function(){return e(".comment-popover-holder").hide(),t.container_set(""),!1})},this.setup_content=function(){e("#comments_sidebar").on("mousedown",".comment-content",function(){var i;if("n"==CommentPress.texthighlighter.commentform.has_commentform()){t.highlighter_disable();return}i=e(this).parent().prop("id"),t.container_set(i),t.highlighter_enable()}),e("#comments_sidebar").on("mouseup",".comment-content",function(){var i,o;"n"!=CommentPress.texthighlighter.commentform.has_commentform()&&(i=t.container_get())!=(o=e(this).parent().prop("id"))&&(t.container_set(""),t.highlighter_disable())}),e("#comments_sidebar").on("click",".comment-forwardlink",function(t){var i,o,n,c,s,l,r,h;t.preventDefault(),o=e(this).prop("href").split("#")[1],(i=e(this).parents("li.comment").map(function(){return this})).length>0&&(l='<a href="#comment-'+(c=(n=e(i[0])).prop("id").split("-")[2])+'" class="comment-backlink">'+(s=CommentPress.texthighlighter.utilities.localisation_get("backlink_text"))+"</a>",e("#"+o+" .comment-identifier .comment-backlink").length||e(l).prependTo("#"+o+" .comment-identifier"),(r=e(this).closest(".paragraph_wrapper").prop("id"))!=(h=e("#"+o).closest(".paragraph_wrapper").prop("id"))&&e("#"+h).show(),CommentPress.common.comments.scroll_comments(e("#"+o),300,"flash"))}),e("#comments_sidebar").on("click",".comment-backlink",function(t){var i,o,n;t.preventDefault(),i=e(this).prop("href").split("#")[1],(o=e(this).closest(".paragraph_wrapper").prop("id"))!=(n=e("#"+i).closest(".paragraph_wrapper").prop("id"))&&e("#"+n).show(),CommentPress.common.comments.scroll_comments(e("#"+i),300,"flash"),e(this).remove()})},this.selection_send_to_editor=function(i){var o;e(document).off("click",t.highlighter_comment_handler),o=CommentPress.texthighlighter.utilities.selection_get(t.container_get()),i?"1"==cp_tinymce?e("#wp-comment-wrap").hasClass("html-active")?t.selection_add_to_textarea(o.text):t.selection_add_to_tinymce(o.text):t.selection_add_to_textarea(o.text):"1"==cp_tinymce?e("#wp-comment-wrap").hasClass("html-active")?setTimeout(function(){e("#comment").focus()},200):setTimeout(function(){void 0!==tinymce.activeEditor?tinymce.activeEditor.focus():e("#comment").focus()},200):setTimeout(function(){e("#comment").focus()},200)},this.get_link=function(e){var i,o;return'<a href="#'+(i=t.container_get())+'" class="comment-forwardlink">'+e+"</a>"},this.selection_add_to_textarea=function(i){e("#comment").val(e("#comment").val()+t.get_link(i)),setTimeout(function(){e("#comment").focus(),t.highlights_clear_comment()},200)},this.selection_add_to_tinymce=function(e){tinymce.activeEditor.execCommand("mceInsertContent",!1,t.get_link(e)),setTimeout(function(){tinymce.activeEditor.focus(),t.highlights_clear_comment()},200)},this.highlighter_activate=function(){e("#comments_sidebar .comment-content").highlighter({selector:".comment-popover-holder",minWords:1,complete:function(i){e(document).on("click",t.highlighter_comment_handler)}})},this.highlighter_deactivate=function(){e("#comments_sidebar .comment-content").highlighter("destroy"),e(document).off("click",t.highlighter_comment_handler)},this.highlighter_comment_handler=function(i){e(i.target).closest(".comment-popover-holder").length||(t.highlighter_deactivate(),t.highlighter_activate())},this.highlighter_enable=function(){e("#comments_sidebar .comment-content").highlighter("enable")},this.highlighter_disable=function(){e("#comments_sidebar .comment-content").highlighter("disable")},this.highlights_clear_comment=function(){e("#comments_sidebar .comment-content .inline-highlight").each(function(t){var i=e(this).contents();e(this).replaceWith(i)})}},CommentPress.texthighlighter.utilities.init(),jQuery(document).ready(function(t){t(document).on("commentpress-document-ready",function(t){CommentPress.texthighlighter.textblocks.setup(),CommentPress.texthighlighter.comments.setup()}),t(document).on("commentpress-ajax-comment-added-scrolled",function(t){CommentPress.texthighlighter.utilities.highlights_clear_all()}),t(document).on("commentpress-ajax-comment-added",function(t,e){e.match("#comment-")&&(e=parseInt(e.split("#comment-")[1])),CommentPress.texthighlighter.textblocks.selection_save_for_comment(e),CommentPress.texthighlighter.commentform.current_selection_clear(),CommentPress.texthighlighter.commentform.focus_clear(),CommentPress.texthighlighter.comments.highlighter_deactivate(),CommentPress.texthighlighter.comments.highlighter_activate()}),t(document).on("commentpress-textblock-pre-align commentpress-comment-block-permalink-pre-align commentpress-commenticonbox-pre-align commentpress-link-in-textblock-pre-align",function(t){CommentPress.texthighlighter.commentform.focus_is_active()&&CommentPress.texthighlighter.commentform.comment_content_exists()&&(CommentPress.texthighlighter.utilities.saved_scroll_target_set(CommentPress.settings.textblock.get_scroll_target()),CommentPress.settings.textblock.set_scroll_target("none"))}),t(document).on("commentpress-textblock-click commentpress-comment-block-permalink-clicked commentpress-commenticonbox-clicked commentpress-link-in-textblock-clicked",function(e){CommentPress.texthighlighter.commentform.focus_is_active()&&CommentPress.texthighlighter.commentform.comment_content_exists()&&(CommentPress.settings.textblock.set_scroll_target(CommentPress.texthighlighter.utilities.saved_scroll_target_get()),t(document).click())})});
