!function(e){e.fn.getRangeAt=function(){var n=e.fn.range;if(n.ClearVariables(),n.setRange(),this[0]===document);else{var t=e(n.startContainer).parents().index(this),r=e(n.endContainer).parents().index(this);if(-1===t||-1===r)return n.ClearVariables(),!1}return n},e.fn.wrapSelection=function(n){var t,r,o,i,a,s=e.fn.range,f={fitToWord:!0,wrapRange:!1,selectClass:"sel_"+new Date().getTime(),regexElementBlockers:RegExp(/^BR$/),regexWordCharacterBasic:RegExp(/^\S$/),regexWordCharacterFull:RegExp(/^[A-Za-z0-9':,\-]$/),regexWordPunc:RegExp(/^[:,]$/),regexWordNumbers:RegExp(/^[0-9]$/)},c=e.extend({},f,n);function l(n,t){if(t<0){var r=e.fn.wrapSelection.dom.GetPreviousTextNode(n);r&&(t=(n=r).length)}if(t<n.length-1)return{container:n,offset:t+1,character:n.nodeValue.substr(t+1,1)};var o=e.fn.wrapSelection.dom.GetNextTextNode(n,n.parentNode);if(!o)return{container:n,offset:t,character:""};for(var i=e.fn.wrapSelection.dom.GetNextSiblingElement(n);i&&2&e.fn.compareDocumentPosition(o,i);){if(i.nodeName.match(c.regexElementBlockers))return{container:n,offset:t,character:""};i=e.fn.wrapSelection.dom.GetNextSiblingElement(i)}return{container:o,offset:0,character:o.nodeValue.substr(0,1)}}function u(n,t){if(t>0)return{container:n,offset:t-1,character:n.nodeValue.substr(t-1,1)};var r=e.fn.wrapSelection.dom.GetPreviousTextNode(n);if(!r)return{container:n,offset:t,character:""};for(var o=e.fn.wrapSelection.dom.GetPreviousSiblingElement(n);o&&4&e.fn.compareDocumentPosition(r,o);){if(o.nodeName.match(c.regexElementBlockers))return{container:n,offset:t,character:""};o=e.fn.wrapSelection.dom.GetPreviousSiblingElement(o)}return{container:r,offset:r.length-1,character:r.nodeValue.substr(r.length-1,1)}}function d(){var e=document.createElement("span");return e.className=c.selectClass,e}return(t=this,(r=c.wrapRange)?e.fn.range=r:e(t).getRangeAt(),s.startContainer&&s.endContainer)?(c.fitToWord&&(i=function e(n,t,r){var o=n.nodeValue.substr(t,1);if(c.regexWordCharacterBasic.test(o)){if("normal"===r){var i=u(n,t);if(c.regexWordCharacterFull.test(i.character))return e(i.container,i.offset,"normal")}return{container:n,offset:t}}if("normal"===r&&c.regexWordPunc.test(o)){var i=u(n,t);if(c.regexWordNumbers.test(i.character))return e(i.container,i.offset,"normal")}var a=l(n,t);return 1===a.character.length?e(a.container,a.offset,"reverse"):{container:n,offset:t}}((o=e.fn.range).startContainer,o.startOffset,"normal"),a=function e(n,t,r){var o="";if(t>0)o=n.nodeValue.substr(t-1,1);else{var i=u(n,t);c.regexWordCharacterFull.test(i.character)&&(o=n.nodeValue.substr(t,0,1),t=1)}if(c.regexWordCharacterBasic.test(o)){if("normal"===r){var a=l(n,t-1);if(c.regexWordCharacterFull.test(a.character))return e(a.container,a.offset+1,"normal")}return{container:n,offset:t}}if("normal"===r&&c.regexWordPunc.test(o)){var a=l(n,t);return c.regexWordNumbers.test(a.character)?e(a.container,a.offset,"normal"):{container:n,offset:t-1}}var i=u(n,t-1);return 1===i.character.length?e(i.container,i.offset+1,"reverse"):{container:n,offset:t}}(o.endContainer,o.endOffset,"normal"),o.startContainer=i.container,o.startOffset=i.offset,o.endContainer=a.container,o.endOffset=a.offset),function n(){var t=e.fn.range,r=t.startContainer===t.endContainer;if(3===t.startContainer.nodeType&&t.startOffset>0){var o=t.startContainer.splitText(t.startOffset);r&&(t.endContainer=o,t.endOffset=t.endOffset-t.startContainer.length),t.startContainer=o,t.startOffset=0}3===t.endContainer.nodeType&&t.endOffset<t.endContainer.length&&(t.endContainer.splitText(t.endOffset),t.endOffset=t.endContainer.length)}(),function n(){var t=e.fn.range;if(!t.startContainer||!t.endContainer)return!1;for(var r=t.GetContainedNodes(),o=r.length,i=0,a=0;a<o;a++)if(r[a][0])for(var s=0,f=r[a].length;s<f;s++)e(r[a][s]).find("*").add(e(r[a][s])).contents().add(e(r[a][s])).filter(function(){return 3===this.nodeType&&this.textContent.trim().length>0}).wrap(d()),i+=1;return i}()?s.ClearAllRanges():s.ClearVariables(),e("."+c.selectClass)):e([])},e.fn.range={onlySpacesMatch:RegExp(/[^\t\r\n ]/),containedNodes:null,selection:null,commonAncestorContainer:null,startContainer:null,startOffset:null,endContainer:null,endOffset:null,collapsed:!0,setRange:function(){if(window.getSelection?this.selection=window.getSelection():document.selection&&(this.selection=document.selection.createRange()),this.selection.getRangeAt)var e=this.selection.getRangeAt(0);else{var e=document.createRange();e.setStart(this.selection.anchorNode,this.selection.anchorOffset),e.setEnd(this.selection.focusNode,this.selection.focusOffset)}if(!e.toString().match(this.onlySpacesMatch))return!1;this.startContainer=e.startContainer,this.startOffset=e.startOffset,this.endContainer=e.endContainer,this.endOffset=e.endOffset,this.collapsed=e.collapsed},ClearAllRanges:function(){e.fn.range.selection&&(e.fn.range.selection.removeAllRanges(),e.fn.range.ClearVariables())},ClearVariables:function(){this.selection=null,this.commonAncestorContainer=null,this.containedNodes=null,this.startContainer=null,this.startOffset=null,this.endContainer=null,this.endOffset=null,this.collapsed=!0},GetContainedNodes:function(){return this.doGetContainedNodes()},doGetContainedNodes:function(){if(this.containedNodes)return this.containedNodes;if(!this.startContainer||!this.endContainer)return[];for(var n=this.startContainer,t=this.endContainer,r=Array([]),o=n,i=e.fn.compareDocumentPosition(n,t),a=o.parentNode,s=0;4&i||0===i;){if(16&i)o=o.firstChild;else if(a!==o.parentNode&&(r[++s]=[],a=o.parentNode),r[s].push(o),o=e.fn.wrapSelection.dom.GetNextSiblingOrParent(o),0===i)break;i=e.fn.compareDocumentPosition(o,t)}return this.containedNodes=r,r}},e.fn.wrapSelection.dom={GetNextSiblingElement:function(n){return e.fn.wrapSelection.dom.getElementOrder(n,"next")},GetNextSiblingOrParent:function(n){return e.fn.wrapSelection.dom.getSiblingOrParentOrder(n,"next")},GetNextTextNode:function(n,t){for(;(n=e.fn.wrapSelection.dom.getNodeOrder(n,t,"next"))&&3!==n.nodeType;);return n},GetPreviousSiblingElement:function(e){return this.getElementOrder(e,"previous")},GetPreviousTextNode:function(n,t){for(;(n=e.fn.wrapSelection.dom.getNodeOrder(n,t,"previous"))&&3!==n.nodeType;);return n},getElementOrder:function(e,n){for(n+="Sibling";e[n]&&1!==e[n].nodeType;)e=e[n];return e[n]},getSiblingOrParentOrder:function(e,n){var t=n+"Sibling";return e[t]?e[t]:e.parentNode?this.getSiblingOrParentOrder(e.parentNode,n):null},getNodeOrder:function(e,n,t){if(void 0===n&&(n=document.body),e.hasChildNodes())return"next"===t?e.firstChild:e.lastChild;if(e===n)return null;var r="next"===t?"nextSibling":"previousSibling";if(e[r])return e[r];for(;(e=e.parentNode)&&e!==n;)if(e[r])return e[r];return null}},e.fn.compareDocumentPosition=function(n,t){function r(e){var n;do n=e;while(e=e.parentNode);return n}if("compareDocumentPosition"in document.documentElement)e.fn.compareDocumentPosition=function(e,n){return e.compareDocumentPosition(n)};else if("sourceIndex"in document.documentElement&&"contains"in document.documentElement)e.fn.compareDocumentPosition=function(e,n){function t(e,n){return(e.contains(n)&&16)+(n.contains(e)&&8)+(e.sourceIndex>=0&&n.sourceIndex>=0?(e.sourceIndex<n.sourceIndex&&4)+(e.sourceIndex>n.sourceIndex&&2):1)}function o(e){return"sourceIndex"in e?e:e.parentNode.insertBefore(document.createComment(""),e)}if(e===n)return 0;if(r(e)!==r(n))return 1;if("sourceIndex"in e&&"sourceIndex"in n)return t(e,n);if(e===document)return 20;if(n===document)return 10;var i=o(e),a=o(n),s=t(i,a);return e!==i&&i.parentNode.removeChild(i),n!==a&&a.parentNode.removeChild(a),s};else{function o(e){var n=[];do{for(var t=0,r=e;r=r.previousSibling;)t++;var o=e.parentNode.childNodes.length.toString().length,i=t.toString().length;if(o>i)for(;i<=o;i++)t="0"+t;n.unshift(t)}while((e=e.parentNode)&&e!==document);return n.join(".")}e.fn.compareDocumentPosition=function(e,n){return e===n?0:r(e)!==r(n)?1:e===document||"contains"in e&&"contains"in n&&e.contains(n)?20:n===document||"contains"in e&&"contains"in n&&n.contains(e)?10:function e(n,t){if(n.length===t.length)return n<t?4:2;if(n.length<t.length){var r=t.substr(0,n.length);return n===r?20:e(n,r)}var o=e(t,n);return 4&o?o>>1:o<<1}(o(e),o(n))}}return e.fn.compareDocumentPosition(n,t)}}(jQuery);
