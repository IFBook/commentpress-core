function cpajax_reenable_featured_comments(){"undefined"!=typeof featured_comments&&jQuery.is_function_defined("featured_comments_click")&&featured_comments_click()}function cpajax_reenable_comment_upvoter(){"undefined"!=typeof comment_upvoter&&jQuery.is_function_defined("comment_upvoter_click")&&comment_upvoter_click()}CommentPress.ajax={},CommentPress.ajax.comments=new function(){var me=this,$=jQuery.noConflict();this.cpajax_submitting=!1,this.cpajax_form={},this.cpajax_error={},"undefined"!=typeof CommentPress_AJAX_Settings&&(this.cpajax_live=CommentPress_AJAX_Settings.cpajax_live,this.cpajax_ajax_url=CommentPress_AJAX_Settings.cpajax_ajax_url,this.cpajax_spinner_url=CommentPress_AJAX_Settings.cpajax_spinner_url,this.cpajax_post_id=CommentPress_AJAX_Settings.cpajax_post_id,this.cpajax_post_comment_status=CommentPress_AJAX_Settings.cpajax_post_comment_status,this.cpajax_lang=CommentPress_AJAX_Settings.cpajax_lang,this.cpajax_interval=CommentPress_AJAX_Settings.cpajax_comment_refresh_interval,this.cpajax_nonce=CommentPress_AJAX_Settings.cpajax_nonce),this.init=function(){},this.dom_ready=function(){me.updater(me.cpajax_live),$("#respond_title").after('<div id="cpajax_error_msg"></div>'),$("#submit").after('<img src="'+me.cpajax_spinner_url+'" id="loading" alt="'+me.cpajax_lang[0]+'" />'),$("#loading").hide(),me.cpajax_form=$("#commentform"),me.cpajax_error=$("#cpajax_error_msg"),me.cpajax_error.hide(),me.initialise_form(),me.reassign_comments(),me.edit_comments_setup(),me.listeners()},this.listeners=function(){$(document).on("commentpress-document-ready",function(e){me.reassign_comments(),me.edit_comments_setup(),cpajax_reenable_featured_comments(),cpajax_reenable_comment_upvoter()})},this.reset=function(){$("#loading").hide(),$("#submit").prop("disabled",!1),$("#submit").show(),addComment.enableForm(),me.cpajax_submitting=!1},this.updater=function(e){"1"==e?CommentPress_AJAX_Settings.interval=window.setInterval(me.update,me.cpajax_interval):window.clearInterval(CommentPress_AJAX_Settings.interval)},this.update=function(){var e;me.cpajax_submitting||(e={action:"cpajax_get_new_comments",last_count:CommentPress_AJAX_Settings.cpajax_comment_count,post_id:me.cpajax_post_id,_ajax_nonce:me.cpajax_nonce},$.post(me.cpajax_ajax_url,e,function(e,t){"success"==t&&me.callback(e)},"json"))},this.callback=function(data){var diff,i,comment;if(diff=parseInt(data.cpajax_comment_count)-parseInt(CommentPress_AJAX_Settings.cpajax_comment_count),diff>0)for(i=1;i<=diff;i++)comment=eval("data.cpajax_new_comment_"+i),me.add_new_comment($(comment.markup),comment.text_sig,comment.parent,comment.id),CommentPress_AJAX_Settings.cpajax_comment_count++},this.add_new_comment=function(e,t,a,n){var m,s,i,o,c,r,_;$("div.comments_container").find("#li-comment-"+n)[0]||(s="#para_heading-"+t,i=$((m="#para_wrapper-"+t)+" ol.commentlist").first(),"0"!=a?(c=$((o="#li-comment-"+a)+" > ol.children").first())[0]?e.hide().addClass("comment-highlighted").appendTo(c).slideDown("fast",function(){e.addClass("comment-fade")}):e.wrap('<ol class="children" />').parent().addClass("comment-highlighted").hide().appendTo(o).slideDown("fast",function(){e.parent().addClass("comment-fade")}):i[0]?e.hide().addClass("comment-highlighted").appendTo(i).slideDown("fast",function(){e.addClass("comment-fade")}):e.wrap('<ol class="commentlist" />').parent().addClass("comment-highlighted").hide().prependTo(m).slideDown("fast",function(){e.parent().addClass("comment-fade")}),_=parseInt($(s+" a span.cp_comment_num").text())+1,me.update_comments_para_heading(s,_),(r=$(s)).addClass("notransition"),r.hasClass("heading-fade")&&r.removeClass("heading-fade"),r.hasClass("heading-highlighted")&&r.removeClass("heading-highlighted"),r.addClass("heading-highlighted"),r.removeClass("notransition"),r.height(),r.addClass("heading-fade"),me.update_para_icon(t,_),me.reassign_comments(),me.edit_comments_setup(),cpajax_reenable_featured_comments(),cpajax_reenable_comment_upvoter(),$(document).trigger("commentpress-ajax-new-comment-added",[n]))},this.reassign_comments=function(){var e,t,a,n;(n=$("#comments_sidebar .comment-wrapper .comment-assign")).show(),n.draggable({helper:"clone",cursor:"move"}),$("#content .post .textblock").droppable({accept:".comment-assign",hoverClass:"selected_para selected_dropzone",drop:function(n,m){e=$(this).prop("id").split("-")[1],t={resizable:!1,width:400,height:200,zIndex:3999,modal:!0,dialogClass:"wp-dialog",buttons:{Yes:function(){$(this).dialog("option","disabled",!0),$(".ui-dialog-buttonset").html('<img src="'+me.cpajax_spinner_url+'" id="loading" alt="'+me.cpajax_lang[0]+'" />'),$(".ui-dialog-title").html(me.cpajax_lang[9]),$(".cp_alert_text").html(me.cpajax_lang[10]),me.reassign(e,m)},Cancel:function(){$(this).dialog("close"),$(this).dialog("destroy"),$(this).remove()}}},a=me.cpajax_lang[8],$('<div><p class="cp_alert_text">'+a+"</p></div>").prop("title",me.cpajax_lang[7]).appendTo("body").dialog(t)}})},this.reassign=function(e,t){var a,n,m;a=$(t.draggable).prop("id").split("-")[1],m=n=$(t.draggable).closest("li.comment"),0==n.siblings("li.comment").length&&(m=n.parent("ol.commentlist")),$(m).slideUp("slow",function(){var t;t={action:"cpajax_reassign_comment",text_signature:e,comment_id:a,_ajax_nonce:me.cpajax_nonce},$.post(me.cpajax_ajax_url,t,function(e,t){"success"==t?document.location.reload(!0):alert(t)},"json")})},this.add_comment=function(e){var t,a,n,m,s,i,o,c,r="";t=me.cpajax_form.find("#text_signature").val(),a=me.cpajax_form.find("#comment_parent").val(),m="#para_heading-"+t,$(n="#para_wrapper-"+t).removeClass("no_comments"),$(m).removeClass("no_comments"),null!=e&&("0"!=a?(i=$((s="#li-comment-"+a)+" > ol.children").first())[0]?(e.find(s+" > ol.children").first().children().last().clone().appendTo(i).hide(),list_item=$(s+" > ol.children").first().children().last(),list_item_id=$(s+" > ol.children").first().children().last().prop("id"),r=me.cleanup(list_item,list_item_id)):(e.find(s+" > ol.children").first().clone().appendTo(s).hide(),list_item=$(s+" > ol.children").first(),list_item_id=$(s+" > ol.children").first().children().last().prop("id"),r=me.cleanup(list_item,list_item_id)):(o=$(n+" > ol.commentlist").first())[0]?(e.find(n+" > ol.commentlist").first().children().last().clone().appendTo(o).hide(),list_item=$(n+" > ol.commentlist").first().children().last(),list_item_id=$(n+" > ol.commentlist").first().children().last().prop("id"),r=me.cleanup(list_item,list_item_id)):(e.find(n+" > ol.commentlist").first().clone().prependTo(n).hide(),list_item=$(n+" > ol.commentlist").first(),list_item_id=$(n+" > ol.commentlist").first().children().last().prop("id"),r=me.cleanup(list_item,list_item_id))),$("#respond").slideUp("fast",function(){addComment.cancelForm()}),c=parseInt($(m+" a span.cp_comment_num").text())+1,me.update_comments_para_heading(m,c),me.update_para_icon(t,c),""!=t?CommentPress.common.content.scroll_page($("#textblock-"+t)):CommentPress.theme.viewport.scroll_to_top(0,cp_scroll_speed),me.reassign_comments(),me.cpajax_form.find("#comment").val(""),me.edit_comments_setup(),cpajax_reenable_featured_comments(),cpajax_reenable_comment_upvoter(),$(document).trigger("commentpress-ajax-comment-added",[r])},this.cleanup=function(e,t){var a,n;return a="#comment-"+t.toString().split("-")[2],(n=$(a)).addClass("comment-highlighted"),$(e).slideDown("slow",function(){$("#comments_sidebar .sidebar_contents_wrapper").stop(!0).scrollTo(n,{duration:cp_scroll_speed,axis:"y",onAfter:function(){n.addClass("comment-fade"),$(document).trigger("commentpress-ajax-comment-added-scrolled")}})}),a},this.update_comments_para_heading=function(e,t){$(e+" a span.cp_comment_num").text(t.toString()),1==t&&$(e+" a span.cp_comment_word").text(me.cpajax_lang[11]),t>1&&$(e+" a span.cp_comment_word").text(me.cpajax_lang[12])},this.update_para_icon=function(e,t){var a;$((a="#textblock-"+e)+" span small").text(t.toString()),1==t&&($(a+" span.commenticonbox a.para_permalink").removeClass("no_comments"),$(a+" span.commenticonbox a.para_permalink").addClass("has_comments"),$(a+" span small").css("visibility","visible"))},this.initialise_form=function(){$("#commentform").off("submit"),$("#commentform").on("submit",function(e){if(me.cpajax_submitting=!0,me.cpajax_error.hide(),me.cpajax_form.find("#author")[0]){if(""==me.cpajax_form.find("#author").val())return me.cpajax_error.html('<span class="error">'+me.cpajax_lang[1]+"</span>"),me.cpajax_error.show(),me.cpajax_submitting=!1,!1;if(""==me.cpajax_form.find("#email").val())return me.cpajax_error.html('<span class="error">'+me.cpajax_lang[2]+"</span>"),me.cpajax_error.show(),me.cpajax_submitting=!1,!1;if(!/^([a-zA-Z0-9_\.\-])+\@(([a-zA-Z0-9\-])+\.)+([a-zA-Z0-9]{2,4})+$/.test(me.cpajax_form.find("#email").val()))return me.cpajax_error.html('<span class="error">'+me.cpajax_lang[3]+"</span>"),me.cpajax_error.show(),e.preventDefault&&e.preventDefault(),me.cpajax_submitting=!1,!1}return"1"==cp_tinymce&&(tinyMCE.triggerSave(),addComment.disableForm()),""==me.cpajax_form.find("#comment").val()?(me.cpajax_error.html('<span class="error">'+me.cpajax_lang[4]+"</span>"),me.cpajax_error.show(),addComment.enableForm(),me.cpajax_submitting=!1,!1):"y"==me.cpajax_form.find("#cp_edit_comment").val()?(e.preventDefault&&e.preventDefault(),me.edit_comment($(this))):($(this).ajaxSubmit({beforeSubmit:function(){$("#loading").show(),$("#submit").prop("disabled","disabled"),$("#submit").hide()},error:function(e){var t;return me.cpajax_error.empty(),t=e.responseText.match(/<p>(.*)<\/p>/),me.cpajax_error.html('<span class="error">'+t[1]+"</span>"),me.cpajax_error.show(),me.reset(),!1},success:function(e){var t;t=$.parseHTML?$($.parseHTML(e)):$(e);try{me.add_comment(t),me.reset()}catch(e){me.reset(),alert(me.cpajax_lang[6]+"\n\n"+e)}}}),!1)})},this.edit_comments_setup=function(){"open"===this.cpajax_post_comment_status&&($("#comments_sidebar").off("click",".comment-edit-link"),$("#comments_sidebar").on("click",".comment-edit-link",function(e){var t;e.preventDefault(),t=parseInt(this.href.split("c=")[1]),me.get_comment(t)}))},this.get_comment=function(e){var t;me.cpajax_submitting||(me.cpajax_submitting=!0,t={action:"cpajax_get_comment",comment_id:e,_ajax_nonce:me.cpajax_nonce},$.post(me.cpajax_ajax_url,t,function(e,t){"success"==t?me.get_comment_callback(e):me.cpajax_submitting=!1},"json"))},this.get_comment_callback=function(e){0!==parseInt(e.sel_start)&&0!==parseInt(e.sel_end)?CommentPress.texthighlighter.commentform.current_selection_set({start:parseInt(e.sel_start),end:parseInt(e.sel_end)}):CommentPress.texthighlighter.commentform.current_selection_clear(),addComment.moveFormToEdit("comment-"+e.id,e.id,"respond",e.post_id,e.text_sig,e.content,e.nonce),$(document).trigger("commentpress-ajax-comment-callback",[e]),me.cpajax_submitting=!1},this.edit_comment=function(e){return me.cpajax_submitting=!0,e.ajaxSubmit({url:me.cpajax_ajax_url,data:{action:"cpajax_edit_comment"},beforeSubmit:function(){$("#loading").show(),$("#submit").prop("disabled","disabled"),$("#submit").hide()},error:function(e){return me.reset(),console.log("edit_comment failed",e),!1},success:function(e){var t;e.id&&($("#respond").slideUp("fast",function(){addComment.commentEditResetForm(),addComment.cancelForm(),$("#respond").show()}),(t=$("#comment-"+e.id)).addClass("comment-highlighted"),$("#comment-"+e.id+" .comment-content").html(e.content),$(document).trigger("commentpress-ajax-comment-edited",[e]),$("#comment-"+e.id+" .comment-content").slideDown("fast",function(){$(window).stop(!0).scrollTo(t,{duration:cp_scroll_speed,axis:"y",offset:CommentPress.theme.header.get_offset(),onAfter:function(){t.addClass("comment-fade")}})}),me.reset())}}),!1}},CommentPress.ajax.comments.init(),jQuery(document).ready(function(e){CommentPress.ajax.comments.dom_ready()});
