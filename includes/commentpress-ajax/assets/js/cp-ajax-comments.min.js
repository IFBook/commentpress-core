function cpajax_reenable_featured_comments(){"undefined"!=typeof featured_comments&&jQuery.is_function_defined("featured_comments_click")&&featured_comments_click()}function cpajax_reenable_comment_upvoter(){"undefined"!=typeof comment_upvoter&&jQuery.is_function_defined("comment_upvoter_click")&&comment_upvoter_click()}CommentPress.ajax={},CommentPress.ajax.comments=new function(){var me=this,$=jQuery.noConflict();this.cpajax_submitting=!1,this.cpajax_form={},this.cpajax_error={},"undefined"!=typeof CommentpressAjaxSettings&&(this.cpajax_live=CommentpressAjaxSettings.cpajax_live,this.cpajax_ajax_url=CommentpressAjaxSettings.cpajax_ajax_url,this.cpajax_spinner_url=CommentpressAjaxSettings.cpajax_spinner_url,this.cpajax_post_id=CommentpressAjaxSettings.cpajax_post_id,this.cpajax_post_comment_status=CommentpressAjaxSettings.cpajax_post_comment_status,this.cpajax_lang=CommentpressAjaxSettings.cpajax_lang,this.cpajax_interval=CommentpressAjaxSettings.cpajax_comment_refresh_interval),this.init=function(){},this.dom_ready=function(){me.updater(me.cpajax_live),$("#respond_title").after('<div id="cpajax_error_msg"></div>'),$("#submit").after('<img src="'+me.cpajax_spinner_url+'" id="loading" alt="'+me.cpajax_lang[0]+'" />'),$("#loading").hide(),me.cpajax_form=$("#commentform"),me.cpajax_error=$("#cpajax_error_msg"),me.cpajax_error.hide(),me.initialise_form(),me.reassign_comments(),me.edit_comments_setup(),me.listeners()},this.listeners=function(){$(document).on("commentpress-document-ready",function(){me.reassign_comments(),me.edit_comments_setup(),cpajax_reenable_featured_comments(),cpajax_reenable_comment_upvoter()})},this.reset=function(){$("#loading").hide(),$("#submit").prop("disabled",!1),$("#submit").show(),addComment.enableForm(),me.cpajax_submitting=!1},this.updater=function(e){"1"==e?CommentpressAjaxSettings.interval=window.setInterval(me.update,me.cpajax_interval):window.clearInterval(CommentpressAjaxSettings.interval)},this.update=function(){me.cpajax_submitting||$.post(me.cpajax_ajax_url,{action:"cpajax_get_new_comments",last_count:CommentpressAjaxSettings.cpajax_comment_count,post_id:me.cpajax_post_id},function(e,t){"success"==t&&me.callback(e)},"json")},this.callback=function(data){var diff,i,comment;if(diff=parseInt(data.cpajax_comment_count)-parseInt(CommentpressAjaxSettings.cpajax_comment_count),diff>0)for(i=1;diff>=i;i++)comment=eval("data.cpajax_new_comment_"+i),me.add_new_comment($(comment.markup),comment.text_sig,comment.parent,comment.id),CommentpressAjaxSettings.cpajax_comment_count++},this.add_new_comment=function(e,t,a,n){var m,s,i,o,c,r,l,d,p;m=$("div.comments_container"),m.find("#li-comment-"+n)[0]||(s="#para_wrapper-"+t,i="#para_heading-"+t,o=$(s+" ol.commentlist").first(),"0"!=a?(c="#li-comment-"+a,r=$(c+" > ol.children").first(),r[0]?e.hide().addClass("comment-highlighted").appendTo(r).slideDown("fast",function(){e.addClass("comment-fade")}):e.wrap('<ol class="children" />').parent().addClass("comment-highlighted").hide().appendTo(c).slideDown("fast",function(){e.parent().addClass("comment-fade")})):o[0]?e.hide().addClass("comment-highlighted").appendTo(o).slideDown("fast",function(){e.addClass("comment-fade")}):e.wrap('<ol class="commentlist" />').parent().addClass("comment-highlighted").hide().prependTo(s).slideDown("fast",function(){e.parent().addClass("comment-fade")}),d=parseInt($(i+" a span.cp_comment_num").text()),p=d+1,me.update_comments_para_heading(i,p),l=$(i),l.addClass("notransition"),l.hasClass("heading-fade")&&l.removeClass("heading-fade"),l.hasClass("heading-highlighted")&&l.removeClass("heading-highlighted"),l.addClass("heading-highlighted"),l.removeClass("notransition"),l.height(),l.addClass("heading-fade"),me.update_para_icon(t,p),me.reassign_comments(),me.edit_comments_setup(),cpajax_reenable_featured_comments(),cpajax_reenable_comment_upvoter(),$(document).trigger("commentpress-ajax-new-comment-added",[n]))},this.reassign_comments=function(){var e,t,a,n,m,s,e=$("#comments_sidebar .comment-wrapper .comment-assign");e.show(),e.draggable({helper:"clone",cursor:"move"}),t=$("#content .post .textblock"),t.droppable({accept:".comment-assign",hoverClass:"selected_para selected_dropzone",drop:function(e,t){a=$(this).prop("id").split("-")[1],n={resizable:!1,width:400,height:200,zIndex:3999,modal:!0,dialogClass:"wp-dialog",buttons:{Yes:function(){$(this).dialog("option","disabled",!0),$(".ui-dialog-buttonset").html('<img src="'+me.cpajax_spinner_url+'" id="loading" alt="'+me.cpajax_lang[0]+'" />'),$(".ui-dialog-title").html(me.cpajax_lang[9]),$(".cp_alert_text").html(me.cpajax_lang[10]),me.reassign(a,t)},Cancel:function(){$(this).dialog("close"),$(this).dialog("destroy"),$(this).remove()}}},m=me.cpajax_lang[8],s=$('<div><p class="cp_alert_text">'+m+"</p></div>"),s.prop("title",me.cpajax_lang[7]).appendTo("body").dialog(n)}})},this.reassign=function(e,t){var a,n,m,s,i;a=$(t.draggable).prop("id").split("-")[1],n=$(t.draggable).closest("li.comment"),m=n,s=n.siblings("li.comment"),0==s.length&&(i=n.parent("ol.commentlist"),m=i),$(m).slideUp("slow",function(){$.post(me.cpajax_ajax_url,{action:"cpajax_reassign_comment",text_signature:e,comment_id:a},function(e,t){"success"==t?document.location.reload(!0):alert(t)},"json")})},this.add_comment=function(e){var t,a,n,m,s,i,o,c,r,l,d="";t=me.cpajax_form.find("#text_signature").val(),a=me.cpajax_form.find("#comment_parent").val(),n="#para_wrapper-"+t,m="#para_heading-"+t,$(n).removeClass("no_comments"),$(m).removeClass("no_comments"),"undefined"!=typeof e&&null!==e&&("0"!=a?(s="#li-comment-"+a,i=$(s+" > ol.children").first(),i[0]?(l=e.find(s+" > ol.children").first().children().last().clone(),l.appendTo(i).hide(),list_item=$(s+" > ol.children").first().children().last(),list_item_id=$(s+" > ol.children").first().children().last().prop("id"),d=me.cleanup(list_item,list_item_id)):(l=e.find(s+" > ol.children").first().clone(),l.appendTo(s).hide(),list_item=$(s+" > ol.children").first(),list_item_id=$(s+" > ol.children").first().children().last().prop("id"),d=me.cleanup(list_item,list_item_id))):(o=$(n+" > ol.commentlist").first(),o[0]?(l=e.find(n+" > ol.commentlist").first().children().last().clone(),l.appendTo(o).hide(),list_item=$(n+" > ol.commentlist").first().children().last(),list_item_id=$(n+" > ol.commentlist").first().children().last().prop("id"),d=me.cleanup(list_item,list_item_id)):(l=e.find(n+" > ol.commentlist").first().clone(),l.prependTo(n).hide(),list_item=$(n+" > ol.commentlist").first(),list_item_id=$(n+" > ol.commentlist").first().children().last().prop("id"),d=me.cleanup(list_item,list_item_id)))),$("#respond").slideUp("fast",function(){addComment.cancelForm()}),c=parseInt($(m+" a span.cp_comment_num").text()),r=c+1,me.update_comments_para_heading(m,r),me.update_para_icon(t,r),""!=t?CommentPress.common.content.scroll_page($("#textblock-"+t)):CommentPress.theme.viewport.scroll_to_top(0,cp_scroll_speed),me.reassign_comments(),me.cpajax_form.find("#comment").val(""),me.edit_comments_setup(),cpajax_reenable_featured_comments(),cpajax_reenable_comment_upvoter(),$(document).trigger("commentpress-ajax-comment-added",[d])},this.cleanup=function(e,t){var a,n;return a="#comment-"+t.toString().split("-")[2],n=$(a),n.addClass("comment-highlighted"),$(e).slideDown("slow",function(){$("#comments_sidebar .sidebar_contents_wrapper").stop(!0).scrollTo(n,{duration:cp_scroll_speed,axis:"y",onAfter:function(){n.addClass("comment-fade"),$(document).trigger("commentpress-ajax-comment-added-scrolled")}})}),a},this.update_comments_para_heading=function(e,t){$(e+" a span.cp_comment_num").text(t.toString()),1==t&&$(e+" a span.cp_comment_word").text(me.cpajax_lang[11]),t>1&&$(e+" a span.cp_comment_word").text(me.cpajax_lang[12])},this.update_para_icon=function(e,t){var a;a="#textblock-"+e,$(a+" span small").text(t.toString()),1==t&&($(a+" span.commenticonbox a.para_permalink").removeClass("no_comments"),$(a+" span.commenticonbox a.para_permalink").addClass("has_comments"),$(a+" span small").css("visibility","visible"))},this.initialise_form=function(){$("#commentform").off("submit"),$("#commentform").on("submit",function(e){var t;if(me.cpajax_submitting=!0,me.cpajax_error.hide(),me.cpajax_form.find("#author")[0]){if(""==me.cpajax_form.find("#author").val())return me.cpajax_error.html('<span class="error">'+me.cpajax_lang[1]+"</span>"),me.cpajax_error.show(),me.cpajax_submitting=!1,!1;if(""==me.cpajax_form.find("#email").val())return me.cpajax_error.html('<span class="error">'+me.cpajax_lang[2]+"</span>"),me.cpajax_error.show(),me.cpajax_submitting=!1,!1;if(t=/^([a-zA-Z0-9_\.\-])+\@(([a-zA-Z0-9\-])+\.)+([a-zA-Z0-9]{2,4})+$/,!t.test(me.cpajax_form.find("#email").val()))return me.cpajax_error.html('<span class="error">'+me.cpajax_lang[3]+"</span>"),me.cpajax_error.show(),e.preventDefault&&e.preventDefault(),me.cpajax_submitting=!1,!1}return"1"==cp_tinymce&&(tinyMCE.triggerSave(),addComment.disableForm()),""==me.cpajax_form.find("#comment").val()?(me.cpajax_error.html('<span class="error">'+me.cpajax_lang[4]+"</span>"),me.cpajax_error.show(),addComment.enableForm(),me.cpajax_submitting=!1,!1):"y"==me.cpajax_form.find("#cp_edit_comment").val()?(e.preventDefault&&e.preventDefault(),me.edit_comment($(this))):($(this).ajaxSubmit({beforeSubmit:function(){$("#loading").show(),$("#submit").prop("disabled","disabled"),$("#submit").hide()},error:function(e){var t;return me.cpajax_error.empty(),t=e.responseText.match(/<p>(.*)<\/p>/),me.cpajax_error.html('<span class="error">'+t[1]+"</span>"),me.cpajax_error.show(),me.reset(),!1},success:function(e){var t;t=$($.parseHTML?$.parseHTML(e):e);try{me.add_comment(t),me.reset()}catch(a){me.reset(),alert(me.cpajax_lang[6]+"\n\n"+a)}}}),!1)})},this.edit_comments_setup=function(){"open"===this.cpajax_post_comment_status&&($("#comments_sidebar").off("click",".comment-edit-link"),$("#comments_sidebar").on("click",".comment-edit-link",function(e){var t;e.preventDefault(),t=parseInt(this.href.split("c=")[1]),me.get_comment(t)}))},this.get_comment=function(e){me.cpajax_submitting||(me.cpajax_submitting=!0,$.post(me.cpajax_ajax_url,{action:"cpajax_get_comment",comment_id:e},function(e,t){"success"==t?me.get_comment_callback(e):me.cpajax_submitting=!1},"json"))},this.get_comment_callback=function(e){0!==parseInt(e.sel_start)&&0!==parseInt(e.sel_end)?CommentPress.texthighlighter.commentform.current_selection_set({start:parseInt(e.sel_start),end:parseInt(e.sel_end)}):CommentPress.texthighlighter.commentform.current_selection_clear(),addComment.moveFormToEdit("comment-"+e.id,e.id,"respond",e.post_id,e.text_sig,e.content,e.nonce),$(document).trigger("commentpress-ajax-comment-callback",[e]),me.cpajax_submitting=!1},this.edit_comment=function(e){return me.cpajax_submitting=!0,e.ajaxSubmit({url:me.cpajax_ajax_url,data:{action:"cpajax_edit_comment"},beforeSubmit:function(){$("#loading").show(),$("#submit").prop("disabled","disabled"),$("#submit").hide()},error:function(e){return me.reset(),console.log("edit_comment failed",e),!1},success:function(e){var t,a;t=JSON.parse(e),$("#respond").slideUp("fast",function(){addComment.commentEditResetForm(),addComment.cancelForm(),$("#respond").show()}),a=$("#comment-"+t.id),a.addClass("comment-highlighted"),$("#comment-"+t.id+" .comment-content").html(t.content),$(document).trigger("commentpress-ajax-comment-edited",[t]),$("#comment-"+t.id+" .comment-content").slideDown("fast",function(){$(window).stop(!0).scrollTo(a,{duration:cp_scroll_speed,axis:"y",offset:CommentPress.theme.header.get_offset(),onAfter:function(){a.addClass("comment-fade")}})}),me.reset()}}),!1}},CommentPress.ajax.comments.init(),jQuery(document).ready(function(){CommentPress.ajax.comments.dom_ready()});
